(window.webpackJsonp=window.webpackJsonp||[]).push([[36],{439:function(a,s,t){"use strict";t.r(s);var e=t(26),r=Object(e.a)({},(function(){var a=this,s=a.$createElement,t=a._self._c||s;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("h1",{attrs:{id:"kubernetes集群安全机制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#kubernetes集群安全机制"}},[a._v("#")]),a._v(" Kubernetes集群安全机制")]),a._v(" "),t("h2",{attrs:{id:"概述"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#概述"}},[a._v("#")]),a._v(" 概述")]),a._v(" "),t("p",[a._v("当我们访问K8S集群时，需要经过三个步骤完成具体操作")]),a._v(" "),t("ul",[t("li",[a._v("认证")]),a._v(" "),t("li",[a._v("鉴权【授权】")]),a._v(" "),t("li",[a._v("准入控制")])]),a._v(" "),t("p",[a._v("进行访问的时候，都需要经过 apiserver， apiserver做统一协调，比如门卫")]),a._v(" "),t("ul",[t("li",[a._v("访问过程中，需要证书、token、或者用户名和密码")]),a._v(" "),t("li",[a._v("如果访问pod需要serviceAccount")])]),a._v(" "),t("p",[t("img",{attrs:{src:"images/image-20201118092356107.png",alt:"image-20201118092356107"}})]),a._v(" "),t("h3",{attrs:{id:"认证"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#认证"}},[a._v("#")]),a._v(" 认证")]),a._v(" "),t("p",[a._v("对外不暴露8080端口，只能内部访问，对外使用的端口6443")]),a._v(" "),t("p",[a._v("客户端身份认证常用方式")]),a._v(" "),t("ul",[t("li",[a._v("https证书认证，基于ca证书")]),a._v(" "),t("li",[a._v("http token认证，通过token来识别用户")]),a._v(" "),t("li",[a._v("http基本认证，用户名 + 密码认证")])]),a._v(" "),t("h3",{attrs:{id:"鉴权"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#鉴权"}},[a._v("#")]),a._v(" 鉴权")]),a._v(" "),t("p",[a._v("基于RBAC进行鉴权操作")]),a._v(" "),t("p",[a._v("基于角色访问控制")]),a._v(" "),t("h3",{attrs:{id:"准入控制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#准入控制"}},[a._v("#")]),a._v(" 准入控制")]),a._v(" "),t("p",[a._v("就是准入控制器的列表，如果列表有请求内容就通过，没有的话 就拒绝")]),a._v(" "),t("h2",{attrs:{id:"rbac介绍"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#rbac介绍"}},[a._v("#")]),a._v(" RBAC介绍")]),a._v(" "),t("p",[a._v("基于角色的访问控制，为某个角色设置访问内容，然后用户分配该角色后，就拥有该角色的访问权限")]),a._v(" "),t("p",[t("img",{attrs:{src:"images/image-20201118093949893.png",alt:"image-20201118093949893"}})]),a._v(" "),t("p",[a._v("k8s中有默认的几个角色")]),a._v(" "),t("ul",[t("li",[a._v("role：特定命名空间访问权限")]),a._v(" "),t("li",[a._v("ClusterRole：所有命名空间的访问权限")])]),a._v(" "),t("p",[a._v("角色绑定")]),a._v(" "),t("ul",[t("li",[a._v("roleBinding：角色绑定到主体")]),a._v(" "),t("li",[a._v("ClusterRoleBinding：集群角色绑定到主体")])]),a._v(" "),t("p",[a._v("主体")]),a._v(" "),t("ul",[t("li",[a._v("user：用户")]),a._v(" "),t("li",[a._v("group：用户组")]),a._v(" "),t("li",[a._v("serviceAccount：服务账号")])]),a._v(" "),t("h2",{attrs:{id:"rbac实现鉴权"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#rbac实现鉴权"}},[a._v("#")]),a._v(" RBAC实现鉴权")]),a._v(" "),t("ul",[t("li",[a._v("创建命名空间")])]),a._v(" "),t("h3",{attrs:{id:"创建命名空间"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#创建命名空间"}},[a._v("#")]),a._v(" 创建命名空间")]),a._v(" "),t("p",[a._v("我们可以首先查看已经存在的命名空间")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[a._v("kubectl get namespace\n")])])]),t("p",[t("img",{attrs:{src:"images/image-20201118094516426.png",alt:"image-20201118094516426"}})]),a._v(" "),t("p",[a._v("然后我们创建一个自己的命名空间  roledemo")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[a._v("kubectl create ns roledemo\n")])])]),t("h3",{attrs:{id:"命名空间创建pod"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#命名空间创建pod"}},[a._v("#")]),a._v(" 命名空间创建Pod")]),a._v(" "),t("p",[a._v("为什么要创建命名空间？因为如果不创建命名空间的话，默认是在default下")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[a._v("kubectl run nginx --image"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("nginx -n roledemo\n")])])]),t("h3",{attrs:{id:"创建角色"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#创建角色"}},[a._v("#")]),a._v(" 创建角色")]),a._v(" "),t("p",[a._v("我们通过 rbac-role.yaml进行创建")]),a._v(" "),t("p",[t("img",{attrs:{src:"images/image-20201118094851338.png",alt:"image-20201118094851338"}})]),a._v(" "),t("p",[a._v("tip：这个角色只对pod 有 get、list权限")]),a._v(" "),t("p",[a._v("然后通过 yaml创建我们的role")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 创建")]),a._v("\nkubectl apply -f rbac-role.yaml\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 查看")]),a._v("\nkubectl get role -n roledemo\n")])])]),t("p",[t("img",{attrs:{src:"images/image-20201118095141786.png",alt:"image-20201118095141786"}})]),a._v(" "),t("h3",{attrs:{id:"创建角色绑定"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#创建角色绑定"}},[a._v("#")]),a._v(" 创建角色绑定")]),a._v(" "),t("p",[a._v("我们还是通过 role-rolebinding.yaml 的方式，来创建我们的角色绑定")]),a._v(" "),t("p",[t("img",{attrs:{src:"images/image-20201118095248052.png",alt:"image-20201118095248052"}})]),a._v(" "),t("p",[a._v("然后创建我们的角色绑定")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 创建角色绑定")]),a._v("\nkubectl apply -f rbac-rolebinding.yaml\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 查看角色绑定")]),a._v("\nkubectl get role, rolebinding -n roledemo\n")])])]),t("p",[t("img",{attrs:{src:"images/image-20201118095357067.png",alt:"image-20201118095357067"}})]),a._v(" "),t("h3",{attrs:{id:"使用证书识别身份"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用证书识别身份"}},[a._v("#")]),a._v(" 使用证书识别身份")]),a._v(" "),t("p",[a._v("我们首先得有一个 rbac-user.sh 证书脚本")]),a._v(" "),t("p",[t("img",{attrs:{src:"images/image-20201118095541427.png",alt:"image-20201118095541427"}})]),a._v(" "),t("p",[t("img",{attrs:{src:"images/image-20201118095627954.png",alt:"image-20201118095627954"}})]),a._v(" "),t("p",[a._v("这里包含了很多证书文件，在TSL目录下，需要复制过来")]),a._v(" "),t("p",[a._v("通过下面命令执行我们的脚本")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[a._v("./rbac-user.sh\n")])])]),t("p",[a._v("最后我们进行测试")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 用get命令查看 pod 【有权限】")]),a._v("\nkubectl get pods -n roledemo\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 用get命令查看svc 【没权限】")]),a._v("\nkubectl get svc -n roledmeo\n")])])]),t("p",[t("img",{attrs:{src:"images/image-20201118100051043.png",alt:"image-20201118100051043"}})])])}),[],!1,null,null,null);s.default=r.exports}}]);