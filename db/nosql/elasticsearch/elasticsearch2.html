<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Beats入门简介 | Tang&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/blog/TB5.PNG">
    <meta name="description" content="This is a blog.">
    
    <link rel="preload" href="/blog/assets/css/0.styles.389ed919.css" as="style"><link rel="preload" href="/blog/assets/js/app.96a63ad2.js" as="script"><link rel="preload" href="/blog/assets/js/2.e671b9b2.js" as="script"><link rel="preload" href="/blog/assets/js/3.be9bea65.js" as="script"><link rel="preload" href="/blog/assets/js/19.c6e110df.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.6769ccf0.js"><link rel="prefetch" href="/blog/assets/js/11.46df150a.js"><link rel="prefetch" href="/blog/assets/js/12.e78943d6.js"><link rel="prefetch" href="/blog/assets/js/13.5d361c1d.js"><link rel="prefetch" href="/blog/assets/js/14.13534fd9.js"><link rel="prefetch" href="/blog/assets/js/15.b21fe2e3.js"><link rel="prefetch" href="/blog/assets/js/16.bf5062c1.js"><link rel="prefetch" href="/blog/assets/js/17.65346b85.js"><link rel="prefetch" href="/blog/assets/js/18.6fb1bdc2.js"><link rel="prefetch" href="/blog/assets/js/20.4a33f06a.js"><link rel="prefetch" href="/blog/assets/js/21.28170e84.js"><link rel="prefetch" href="/blog/assets/js/22.9358a818.js"><link rel="prefetch" href="/blog/assets/js/23.136a0f54.js"><link rel="prefetch" href="/blog/assets/js/24.499aeaaf.js"><link rel="prefetch" href="/blog/assets/js/25.3cff72a1.js"><link rel="prefetch" href="/blog/assets/js/26.4ee8c52f.js"><link rel="prefetch" href="/blog/assets/js/27.6e099c82.js"><link rel="prefetch" href="/blog/assets/js/28.bfc3427b.js"><link rel="prefetch" href="/blog/assets/js/29.ce801df4.js"><link rel="prefetch" href="/blog/assets/js/30.724cfbb6.js"><link rel="prefetch" href="/blog/assets/js/31.ffd0a663.js"><link rel="prefetch" href="/blog/assets/js/32.feba734b.js"><link rel="prefetch" href="/blog/assets/js/33.e8d22227.js"><link rel="prefetch" href="/blog/assets/js/34.a12f435a.js"><link rel="prefetch" href="/blog/assets/js/35.31d4b272.js"><link rel="prefetch" href="/blog/assets/js/36.a6d04eab.js"><link rel="prefetch" href="/blog/assets/js/37.d8aae5c8.js"><link rel="prefetch" href="/blog/assets/js/38.2d9e0b46.js"><link rel="prefetch" href="/blog/assets/js/39.f9bd73de.js"><link rel="prefetch" href="/blog/assets/js/4.850a33ae.js"><link rel="prefetch" href="/blog/assets/js/40.5ef065c5.js"><link rel="prefetch" href="/blog/assets/js/41.014df883.js"><link rel="prefetch" href="/blog/assets/js/42.199ac029.js"><link rel="prefetch" href="/blog/assets/js/43.69e01de9.js"><link rel="prefetch" href="/blog/assets/js/44.b00eed2f.js"><link rel="prefetch" href="/blog/assets/js/45.f676a314.js"><link rel="prefetch" href="/blog/assets/js/46.d76b7b8a.js"><link rel="prefetch" href="/blog/assets/js/47.fa6622ba.js"><link rel="prefetch" href="/blog/assets/js/48.629ae724.js"><link rel="prefetch" href="/blog/assets/js/49.3f36b8cf.js"><link rel="prefetch" href="/blog/assets/js/5.c1ab3a44.js"><link rel="prefetch" href="/blog/assets/js/50.6429bdc0.js"><link rel="prefetch" href="/blog/assets/js/51.b7cb8687.js"><link rel="prefetch" href="/blog/assets/js/52.7360a167.js"><link rel="prefetch" href="/blog/assets/js/53.fb5fcabb.js"><link rel="prefetch" href="/blog/assets/js/54.f5ac5958.js"><link rel="prefetch" href="/blog/assets/js/55.592b0348.js"><link rel="prefetch" href="/blog/assets/js/56.d17f3acb.js"><link rel="prefetch" href="/blog/assets/js/57.11aeb3ed.js"><link rel="prefetch" href="/blog/assets/js/58.1b2f9f8b.js"><link rel="prefetch" href="/blog/assets/js/59.c5633b7a.js"><link rel="prefetch" href="/blog/assets/js/6.0106dfd1.js"><link rel="prefetch" href="/blog/assets/js/60.230b2314.js"><link rel="prefetch" href="/blog/assets/js/61.f9cb1ad6.js"><link rel="prefetch" href="/blog/assets/js/62.92f2597d.js"><link rel="prefetch" href="/blog/assets/js/63.25fe8e93.js"><link rel="prefetch" href="/blog/assets/js/64.08acc4bc.js"><link rel="prefetch" href="/blog/assets/js/65.cba08f56.js"><link rel="prefetch" href="/blog/assets/js/66.2aff3910.js"><link rel="prefetch" href="/blog/assets/js/67.23dfb624.js"><link rel="prefetch" href="/blog/assets/js/68.7e1a9696.js"><link rel="prefetch" href="/blog/assets/js/69.127d4ccb.js"><link rel="prefetch" href="/blog/assets/js/7.34cfb431.js"><link rel="prefetch" href="/blog/assets/js/70.cb7a9ca8.js"><link rel="prefetch" href="/blog/assets/js/71.fc5012c0.js"><link rel="prefetch" href="/blog/assets/js/72.04308961.js"><link rel="prefetch" href="/blog/assets/js/73.3b80efd9.js"><link rel="prefetch" href="/blog/assets/js/74.009897a1.js"><link rel="prefetch" href="/blog/assets/js/75.00bb0c95.js"><link rel="prefetch" href="/blog/assets/js/76.0b9619cc.js"><link rel="prefetch" href="/blog/assets/js/77.3cdf8f24.js"><link rel="prefetch" href="/blog/assets/js/78.2db1c727.js"><link rel="prefetch" href="/blog/assets/js/79.342c3faa.js"><link rel="prefetch" href="/blog/assets/js/8.51e80c5b.js"><link rel="prefetch" href="/blog/assets/js/80.0439653b.js"><link rel="prefetch" href="/blog/assets/js/81.6c0e9802.js"><link rel="prefetch" href="/blog/assets/js/82.e6e1608a.js"><link rel="prefetch" href="/blog/assets/js/83.39a82281.js"><link rel="prefetch" href="/blog/assets/js/84.4415141b.js"><link rel="prefetch" href="/blog/assets/js/85.00b63f10.js"><link rel="prefetch" href="/blog/assets/js/86.1581db60.js"><link rel="prefetch" href="/blog/assets/js/87.4c47bbc2.js"><link rel="prefetch" href="/blog/assets/js/88.10af48c1.js"><link rel="prefetch" href="/blog/assets/js/89.84840655.js"><link rel="prefetch" href="/blog/assets/js/9.c76e1545.js"><link rel="prefetch" href="/blog/assets/js/90.574990da.js"><link rel="prefetch" href="/blog/assets/js/91.a1094788.js"><link rel="prefetch" href="/blog/assets/js/92.7070acb6.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.389ed919.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/TB5.PNG" alt="Tang's Blog" class="logo"> <span class="site-name can-hide">Tang's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术笔记" class="dropdown-title"><span class="title">技术笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="技术笔记" class="mobile-dropdown-title"><span class="title">技术笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/java/" class="nav-link">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/blog/frontend/" class="nav-link">
  前端
</a></li><li class="dropdown-item"><!----> <a href="/blog/db/" class="nav-link router-link-active">
  DB
</a></li><li class="dropdown-item"><!----> <a href="/blog/microservice/" class="nav-link">
  微服务
</a></li><li class="dropdown-item"><!----> <a href="/blog/distribution/" class="nav-link">
  分布式
</a></li><li class="dropdown-item"><!----> <a href="/blog/bigdata/" class="nav-link">
  大数据
</a></li><li class="dropdown-item"><!----> <a href="/blog/devops/" class="nav-link">
  DevOps
</a></li><li class="dropdown-item"><!----> <a href="/blog/newlanguage/" class="nav-link">
  新语言
</a></li><li class="dropdown-item"><!----> <a href="/blog/othertool/" class="nav-link">
  其他工具
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/readbook/" class="nav-link">
  读书分享
</a></li><li class="dropdown-item"><!----> <a href="/blog/guitar/" class="nav-link">
  吉他谱
</a></li><li class="dropdown-item"><!----> <a href="/blog/food/" class="nav-link">
  饮食
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术笔记" class="dropdown-title"><span class="title">技术笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="技术笔记" class="mobile-dropdown-title"><span class="title">技术笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/java/" class="nav-link">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/blog/frontend/" class="nav-link">
  前端
</a></li><li class="dropdown-item"><!----> <a href="/blog/db/" class="nav-link router-link-active">
  DB
</a></li><li class="dropdown-item"><!----> <a href="/blog/microservice/" class="nav-link">
  微服务
</a></li><li class="dropdown-item"><!----> <a href="/blog/distribution/" class="nav-link">
  分布式
</a></li><li class="dropdown-item"><!----> <a href="/blog/bigdata/" class="nav-link">
  大数据
</a></li><li class="dropdown-item"><!----> <a href="/blog/devops/" class="nav-link">
  DevOps
</a></li><li class="dropdown-item"><!----> <a href="/blog/newlanguage/" class="nav-link">
  新语言
</a></li><li class="dropdown-item"><!----> <a href="/blog/othertool/" class="nav-link">
  其他工具
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/readbook/" class="nav-link">
  读书分享
</a></li><li class="dropdown-item"><!----> <a href="/blog/guitar/" class="nav-link">
  吉他谱
</a></li><li class="dropdown-item"><!----> <a href="/blog/food/" class="nav-link">
  饮食
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>关系型</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/db/sql/mysql.html" class="sidebar-link">Mysql</a></li><li><a href="/blog/db/sql/oracle.html" class="sidebar-link">Oracle</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>非关系型</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Redis</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>Elastic Stack</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/db/nosql/elasticsearch/elasticsearch1.html" class="sidebar-link">ElasticSearch</a></li><li><a href="/blog/db/nosql/elasticsearch/elasticsearch2.html" aria-current="page" class="active sidebar-link">Beats入门简介</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/db/nosql/elasticsearch/elasticsearch2.html#项目需求" class="sidebar-link">项目需求</a></li><li class="sidebar-sub-header"><a href="/blog/db/nosql/elasticsearch/elasticsearch2.html#业务流程" class="sidebar-link">业务流程</a></li><li class="sidebar-sub-header"><a href="/blog/db/nosql/elasticsearch/elasticsearch2.html#部署nginx" class="sidebar-link">部署Nginx</a></li><li class="sidebar-sub-header"><a href="/blog/db/nosql/elasticsearch/elasticsearch2.html#beats简介" class="sidebar-link">Beats简介</a></li><li class="sidebar-sub-header"><a href="/blog/db/nosql/elasticsearch/elasticsearch2.html#filebeat" class="sidebar-link">Filebeat</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/db/nosql/elasticsearch/elasticsearch2.html#介绍" class="sidebar-link">介绍</a></li><li class="sidebar-sub-header"><a href="/blog/db/nosql/elasticsearch/elasticsearch2.html#为什么要用filebeat" class="sidebar-link">为什么要用Filebeat？</a></li><li class="sidebar-sub-header"><a href="/blog/db/nosql/elasticsearch/elasticsearch2.html#架构" class="sidebar-link">架构</a></li><li class="sidebar-sub-header"><a href="/blog/db/nosql/elasticsearch/elasticsearch2.html#下载" class="sidebar-link">下载</a></li><li class="sidebar-sub-header"><a href="/blog/db/nosql/elasticsearch/elasticsearch2.html#启动" class="sidebar-link">启动</a></li><li class="sidebar-sub-header"><a href="/blog/db/nosql/elasticsearch/elasticsearch2.html#读取文件" class="sidebar-link">读取文件</a></li><li class="sidebar-sub-header"><a href="/blog/db/nosql/elasticsearch/elasticsearch2.html#自定义字段" class="sidebar-link">自定义字段</a></li><li class="sidebar-sub-header"><a href="/blog/db/nosql/elasticsearch/elasticsearch2.html#输出到elasticsearch" class="sidebar-link">输出到ElasticSearch</a></li><li class="sidebar-sub-header"><a href="/blog/db/nosql/elasticsearch/elasticsearch2.html#filebeat工作原理" class="sidebar-link">Filebeat工作原理</a></li><li class="sidebar-sub-header"><a href="/blog/db/nosql/elasticsearch/elasticsearch2.html#input" class="sidebar-link">input</a></li><li class="sidebar-sub-header"><a href="/blog/db/nosql/elasticsearch/elasticsearch2.html#启动命令" class="sidebar-link">启动命令</a></li><li class="sidebar-sub-header"><a href="/blog/db/nosql/elasticsearch/elasticsearch2.html#参数说明" class="sidebar-link">参数说明</a></li><li class="sidebar-sub-header"><a href="/blog/db/nosql/elasticsearch/elasticsearch2.html#读取nginx中的配置文件" class="sidebar-link">读取Nginx中的配置文件</a></li><li class="sidebar-sub-header"><a href="/blog/db/nosql/elasticsearch/elasticsearch2.html#module" class="sidebar-link">Module</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/db/nosql/elasticsearch/elasticsearch2.html#metricbeat" class="sidebar-link">Metricbeat</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/db/nosql/elasticsearch/elasticsearch2.html#metricbeat组成" class="sidebar-link">Metricbeat组成</a></li><li class="sidebar-sub-header"><a href="/blog/db/nosql/elasticsearch/elasticsearch2.html#下载-2" class="sidebar-link">下载</a></li><li class="sidebar-sub-header"><a href="/blog/db/nosql/elasticsearch/elasticsearch2.html#启动-2" class="sidebar-link">启动</a></li><li class="sidebar-sub-header"><a href="/blog/db/nosql/elasticsearch/elasticsearch2.html#system-module配置" class="sidebar-link">system module配置</a></li><li class="sidebar-sub-header"><a href="/blog/db/nosql/elasticsearch/elasticsearch2.html#metricbeat-module" class="sidebar-link">Metricbeat Module</a></li><li class="sidebar-sub-header"><a href="/blog/db/nosql/elasticsearch/elasticsearch2.html#nginx-module" class="sidebar-link">Nginx Module</a></li><li class="sidebar-sub-header"><a href="/blog/db/nosql/elasticsearch/elasticsearch2.html#配置nginx-module" class="sidebar-link">配置nginx module</a></li><li class="sidebar-sub-header"><a href="/blog/db/nosql/elasticsearch/elasticsearch2.html#测试-2" class="sidebar-link">测试</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/db/nosql/elasticsearch/elasticsearch2.html#参考" class="sidebar-link">参考</a></li></ul></li><li><a href="/blog/db/nosql/elasticsearch/elasticsearch3.html" class="sidebar-link">Kibana入门</a></li><li><a href="/blog/db/nosql/elasticsearch/elasticsearch4.html" class="sidebar-link">Logstash入门简介</a></li><li><a href="/blog/db/nosql/elasticsearch/elasticsearch5.html" class="sidebar-link">ElasticStack综合案例</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Neo4j</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Mongodb</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>HBase</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>TimeSeries</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>分布式数据库</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/db/distributed/fercar.html" class="sidebar-link">Fercar 分布式事务</a></li><li><a href="/blog/db/distributed/sharding.html" class="sidebar-link">ShardingSphere 分库分表中间件</a></li><li><a href="/blog/db/distributed/tidb.html" class="sidebar-link">TiDB</a></li><li><a href="/blog/db/distributed/oceanbase.html" class="sidebar-link">OceanBase</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="beats入门简介"><a href="#beats入门简介" class="header-anchor">#</a> Beats入门简介</h1> <p>使用Beat收集nginx日志和指标数据</p> <h2 id="项目需求"><a href="#项目需求" class="header-anchor">#</a> 项目需求</h2> <p>Nginx是一款非常优秀的web服务器，往往nginx服务会作为项目的访问入口，那么，nginx的性能保障就变得非常重要了，如果nginx的运行出现了问题就会对项目有较大的影响，所以，我们需要对nginx的运行有监控措施，实时掌握nginx的运行情况，那就需要收集nginx的运行指标和分析nginx的运行日志了。</p> <h2 id="业务流程"><a href="#业务流程" class="header-anchor">#</a> 业务流程</h2> <p><img src="images/image-20200924081614472.png" alt="image-20200924081614472"></p> <p>说明：</p> <ul><li>通过Beats采集Nginx的指标数据和日志数据</li> <li>Beats采集到数据后发送到Elasticsearch中</li> <li>Kibana读取数据进行分析</li> <li>用户通过Kibana进行查看分析报表</li></ul> <h2 id="部署nginx"><a href="#部署nginx" class="header-anchor">#</a> 部署Nginx</h2> <p>部署教程可以参考这篇博客：<a href="http://www.moguit.cn/#/info?blogUid=e8d3e38ba35b4765ae128256eb44e341" target="_blank" rel="noopener noreferrer">CentOS下如何安装Nginx？<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>部署完成后，我们就可以启动nginx了</p> <p>启动完成后，我们通过下面命令，就可以获取到nginx中的内容了</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">tail</span> -f /var/log/nginx/access.log
</code></pre></div><h2 id="beats简介"><a href="#beats简介" class="header-anchor">#</a> Beats简介</h2> <p>通过查看ElasticStack可以发现，Beats主要用于采集数据</p> <p>官网地址：https://www.elastic.co/cn/beats/</p> <p><img src="images/image-20200924091657242.png" alt="image-20200924091657242"></p> <p>Beats平台其实是一个轻量性数据采集器，通过集合多种单一用途的采集器，从成百上千台机器中向Logstash或ElasticSearch中发送数据。</p> <p><img src="images/image-20200924091716757.png" alt="image-20200924091716757"></p> <p>通过Beats包含以下的数据采集功能</p> <ul><li>Filebeat：采集日志文件</li> <li>Metricbeat：采集指标</li> <li>Packetbeat：采集网络数据</li></ul> <p><img src="images/image-20200924092015934.png" alt="image-20200924092015934"></p> <p>如果我们的数据不需要任何处理，那么就可以直接发送到ElasticSearch中</p> <p>如果们的数据需要经过一些处理的话，那么就可以发送到Logstash中，然后处理完成后，在发送到ElasticSearch</p> <p>最后在通过Kibana对我们的数据进行一系列的可视化展示</p> <p><img src="images/image-20200924092348121.png" alt="image-20200924092348121"></p> <h2 id="filebeat"><a href="#filebeat" class="header-anchor">#</a> Filebeat</h2> <h3 id="介绍"><a href="#介绍" class="header-anchor">#</a> 介绍</h3> <p>Filebeat是一个轻量级的日志采集器</p> <p><img src="images/image-20200924092551044.png" alt="image-20200924092551044"></p> <h3 id="为什么要用filebeat"><a href="#为什么要用filebeat" class="header-anchor">#</a> 为什么要用Filebeat？</h3> <p>当你面对成百上千、甚至成千上万的服务器、虚拟机和溶气气生成的日志时，请告别SSH吧！Filebeat将为你提供一种轻量型方法，用于转发和汇总日志与文件，让简单的事情不再繁华，关于Filebeat的记住以下两点：</p> <ul><li>轻量级日志采集器</li> <li>输送至ElasticSearch或者Logstash，在Kibana中实现可视化</li></ul> <h3 id="架构"><a href="#架构" class="header-anchor">#</a> 架构</h3> <p>用于监控、收集服务器日志文件.</p> <p><img src="images/image-20200924092749077.png" alt="image-20200924092749077"></p> <p>流程如下：</p> <ul><li>首先是input输入，我们可以指定多个数据输入源，然后通过通配符进行日志文件的匹配</li> <li>匹配到日志后，就会使用Harvester（收割机），将日志源源不断的读取到来</li> <li>然后收割机收割到的日志，就传递到Spooler（卷轴），然后卷轴就在将他们传到对应的地方</li></ul> <h3 id="下载"><a href="#下载" class="header-anchor">#</a> 下载</h3> <p>官网地址：https://www.elastic.co/cn/downloads/beats/filebeat</p> <p>选中对应版本的Filebeat，我这里是Centos部署的，所以下载Linux版本</p> <p><img src="images/image-20200924093459418.png" alt="image-20200924093459418"></p> <p>下载后，我们上传到服务器上，然后创建一个文件夹</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 创建文件夹</span>
<span class="token function">mkdir</span> -p /soft/beats
<span class="token comment"># 解压文件</span>
<span class="token function">tar</span> -zxvf filebeat-7.9.1-linux-x86_64.tar.gz 
<span class="token comment"># 重命名</span>
<span class="token function">mv</span> filebeat-7.9.1-linux-x86_64/ filebeat
</code></pre></div><p>然后我们进入到filebeat目录下，创建对应的配置文件</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 进入文件夹</span>
<span class="token builtin class-name">cd</span> filebeats
<span class="token comment"># 创建配置文件</span>
<span class="token function">vim</span> mogublog.yml
</code></pre></div><p>添加如下内容</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span> <span class="token comment"># filebeat input输入</span>
<span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> stdin    <span class="token comment"># 标准输入</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token comment"># 启用标准输入</span>
<span class="token key atrule">setup.template.settings</span><span class="token punctuation">:</span> 
  <span class="token key atrule">index.number_of_shards</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># 指定下载数</span>
<span class="token key atrule">output.console</span><span class="token punctuation">:</span>  <span class="token comment"># 控制台输出</span>
  <span class="token key atrule">pretty</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>   <span class="token comment"># 启用美化功能</span>
  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre></div><h3 id="启动"><a href="#启动" class="header-anchor">#</a> 启动</h3> <p>在我们添加完配置文件后，我们就可以对filebeat进行启动了</p> <div class="language-bash extra-class"><pre class="language-bash"><code>./filebeat -e -c mogublog.yml
</code></pre></div><p><img src="images/image-20200924094825962.png" alt="image-20200924094825962"></p> <p>然后我们在控制台输入hello，就能看到我们会有一个json的输出，是通过读取到我们控制台的内容后输出的</p> <p><img src="images/image-20200924095032365.png" alt="image-20200924095032365"></p> <p>内容如下</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;@timestamp&quot;</span><span class="token operator">:</span><span class="token string">&quot;2019-01-12T12:50:03.585Z&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;@metadata&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span> #元数据信息
        <span class="token property">&quot;beat&quot;</span><span class="token operator">:</span><span class="token string">&quot;filebeat&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;doc&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;version&quot;</span><span class="token operator">:</span><span class="token string">&quot;6.5.4&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;source&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;offset&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token property">&quot;message&quot;</span><span class="token operator">:</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span> #元数据信息
    <span class="token property">&quot;prospector&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;stdin&quot;</span> #元数据信息
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;input&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span> #控制台标准输入
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;stdin&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;beat&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>  #beat版本以及主机信息
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;itcast01&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;hostname&quot;</span><span class="token operator">:</span><span class="token string">&quot;ElasticStack&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;version&quot;</span><span class="token operator">:</span><span class="token string">&quot;6.5.4&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;host&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;ElasticStack&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="读取文件"><a href="#读取文件" class="header-anchor">#</a> 读取文件</h3> <p>我们需要再次创建一个文件，叫 mogublog-log.yml，然后在文件里添加如下内容</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">paths</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> /soft/beats/logs/<span class="token important">*.log</span>
<span class="token key atrule">setup.template.settings</span><span class="token punctuation">:</span>
  <span class="token key atrule">index.number_of_shards</span><span class="token punctuation">:</span> <span class="token number">3</span>
<span class="token key atrule">output.console</span><span class="token punctuation">:</span>
  <span class="token key atrule">pretty</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre></div><p>添加完成后，我们在到下面目录创建一个日志文件</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 创建文件夹</span>
<span class="token function">mkdir</span> -p /soft/beats/logs

<span class="token comment"># 进入文件夹</span>
<span class="token builtin class-name">cd</span> /soft/beats/logs

<span class="token comment"># 追加内容</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;hello&quot;</span> <span class="token operator">&gt;&gt;</span> a.log
</code></pre></div><p>然后我们再次启动filebeat</p> <div class="language-bash extra-class"><pre class="language-bash"><code> ./filebeat -e -c mogublog-log.yml
</code></pre></div><p>能够发现，它已经成功加载到了我们的日志文件 a.log</p> <p><img src="images/image-20200924095926036.png" alt="image-20200924095926036"></p> <p>同时我们还可以继续往文件中追加内容</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">echo</span> <span class="token string">&quot;are you ok ?&quot;</span> <span class="token operator">&gt;&gt;</span> a.log
</code></pre></div><p>追加后，我们再次查看filebeat，也能看到刚刚我们追加的内容</p> <p><img src="images/image-20200924102409656.png" alt="image-20200924102409656"></p> <p>可以看出，已经检测到日志文件有更新，立刻就会读取到更新的内容，并且输出到控制台。</p> <h3 id="自定义字段"><a href="#自定义字段" class="header-anchor">#</a> 自定义字段</h3> <p>但我们的元数据没办法支撑我们的业务时，我们还可以自定义添加一些字段</p> <div class="language-bash extra-class"><pre class="language-bash"><code>filebeat.inputs:
- type: log
  enabled: <span class="token boolean">true</span>
  paths:
    - /soft/beats/logs/*.log
  tags: <span class="token punctuation">[</span><span class="token string">&quot;web&quot;</span>, <span class="token string">&quot;test&quot;</span><span class="token punctuation">]</span>  <span class="token comment">#添加自定义tag，便于后续的处理</span>
  fields:  <span class="token comment">#添加自定义字段</span>
    from: test-web
  fields_under_root: <span class="token boolean">true</span> <span class="token comment">#true为添加到根节点，false为添加到子节点中</span>
setup.template.settings:
  index.number_of_shards: <span class="token number">3</span>
output.console:
  pretty: <span class="token boolean">true</span>
  enable: <span class="token boolean">true</span>
</code></pre></div><p>添加完成后，我们重启 filebeat</p> <div class="language-bash extra-class"><pre class="language-bash"><code>./filebeat -e -c mogublog-log.yml
</code></pre></div><p>然后添加新的数据到 a.log中</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">echo</span> <span class="token string">&quot;test-web&quot;</span> <span class="token operator">&gt;&gt;</span> a.log
</code></pre></div><p>我们就可以看到字段在原来的基础上，增加了两个</p> <p><img src="images/image-20200924103323033.png" alt="image-20200924103323033"></p> <h3 id="输出到elasticsearch"><a href="#输出到elasticsearch" class="header-anchor">#</a> 输出到ElasticSearch</h3> <p>我们可以通过配置，将修改成如下所示</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">paths</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> /soft/beats/logs/<span class="token important">*.log</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;web&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">]</span>
  <span class="token key atrule">fields</span><span class="token punctuation">:</span>
    <span class="token key atrule">from</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>web
  <span class="token key atrule">fields_under_root</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> 
<span class="token key atrule">setup.template.settings</span><span class="token punctuation">:</span>
  <span class="token key atrule">index.number_of_shards</span><span class="token punctuation">:</span> <span class="token number">1</span>
<span class="token key atrule">output.elasticsearch</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;127.0.0.1:9200&quot;</span><span class="token punctuation">]</span>
</code></pre></div><p>启动成功后，我们就能看到它已经成功连接到了es了</p> <p><img src="images/image-20200924145624812.png" alt="image-20200924145624812"></p> <p>然后我们到刚刚的 logs文件夹向 a.log文件中添加内容</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">echo</span> <span class="token string">&quot;hello mogublog&quot;</span> <span class="token operator">&gt;&gt;</span> a.log
</code></pre></div><p>在ES中，我们可以看到，多出了一个 filebeat的索引库</p> <p><img src="images/image-20200924145928050.png" alt="image-20200924145928050"></p> <p>然后我们浏览对应的数据，看看是否有插入的数据内容</p> <p><img src="images/image-20200924150500441.png" alt="image-20200924150500441"></p> <h3 id="filebeat工作原理"><a href="#filebeat工作原理" class="header-anchor">#</a> Filebeat工作原理</h3> <p>Filebeat主要由下面几个组件组成： harvester、prospector 、input</p> <h4 id="harvester"><a href="#harvester" class="header-anchor">#</a> harvester</h4> <ul><li>负责读取单个文件的内容</li> <li>harvester逐行读取每个文件（一行一行读取），并把这些内容发送到输出</li> <li>每个文件启动一个harvester，并且harvester负责打开和关闭这些文件，这就意味着harvester运行时文件描述符保持着打开的状态。</li> <li>在harvester正在读取文件内容的时候，文件被删除或者重命名了，那么Filebeat就会续读这个文件，这就会造成一个问题，就是只要负责这个文件的harvester没用关闭，那么磁盘空间就不会被释放，默认情况下，Filebeat保存问价你打开直到close_inactive到达</li></ul> <h4 id="prospector"><a href="#prospector" class="header-anchor">#</a> prospector</h4> <ul><li><p>prospector负责管理harvester并找到所有要读取的文件来源</p></li> <li><p>如果输入类型为日志，则查找器将查找路径匹配的所有文件，并为每个文件启动一个harvester</p></li> <li><p>Filebeat目前支持两种prospector类型：log和stdin</p></li> <li><p>Filebeat如何保持文件的状态</p> <ul><li>Filebeat保存每个文件的状态并经常将状态刷新到磁盘上的注册文件中</li> <li>该状态用于记住harvester正在读取的最后偏移量，并确保发送所有日志行。</li> <li>如果输出（例如ElasticSearch或Logstash）无法访问，Filebeat会跟踪最后发送的行，并在输出再次可以用时继续读取文件。</li> <li>在Filebeat运行时，每个prospector内存中也会保存的文件状态信息，当重新启动Filebat时，将使用注册文件的数量来重建文件状态，Filebeat将每个harvester在从保存的最后偏移量继续读取</li> <li>文件状态记录在data/registry文件中</li></ul></li></ul> <h3 id="input"><a href="#input" class="header-anchor">#</a> input</h3> <ul><li><p>一个input负责管理harvester，并找到所有要读取的源</p></li> <li><p>如果input类型是log，则input查找驱动器上与已定义的glob路径匹配的所有文件，并为每个文件启动一个harvester</p></li> <li><p>每个input都在自己的Go例程中运行</p></li> <li><p>下面的例子配置Filebeat从所有匹配指定的glob模式的文件中读取行</p></li></ul> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log
  <span class="token key atrule">paths</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> /var/log/<span class="token important">*.log</span>
    <span class="token punctuation">-</span> /var/path2/<span class="token important">*.log</span>
</code></pre></div><h3 id="启动命令"><a href="#启动命令" class="header-anchor">#</a> 启动命令</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>./filebeat -e -c mogublog-es.yml
./filebeat -e -c mogublog-es.yml -d <span class="token string">&quot;publish&quot;</span>
</code></pre></div><h3 id="参数说明"><a href="#参数说明" class="header-anchor">#</a> 参数说明</h3> <ul><li>**-e：**输出到标准输出，默认输出到syslog和logs下</li> <li>**-c：**指定配置文件</li> <li>**-d：**输出debug信息</li></ul> <h3 id="读取nginx中的配置文件"><a href="#读取nginx中的配置文件" class="header-anchor">#</a> 读取Nginx中的配置文件</h3> <p>我们需要创建一个 mogublog-nginx.yml配置文件</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">paths</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> /soft/nginx/<span class="token important">*.log</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;nginx&quot;</span><span class="token punctuation">]</span>
  <span class="token key atrule">fields_under_root</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> 
<span class="token key atrule">setup.template.settings</span><span class="token punctuation">:</span>
  <span class="token key atrule">index.number_of_shards</span><span class="token punctuation">:</span> <span class="token number">1</span>
<span class="token key atrule">output.elasticsearch</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;127.0.0.1:9200&quot;</span><span class="token punctuation">]</span>
</code></pre></div><p>启动后，可以在Elasticsearch中看到索引以及查看数据</p> <p><img src="images/image-20200924161739842.png" alt="image-20200924161739842"></p> <p>可以看到，在message中已经获取到了nginx的日志，但是，内容并没有经过处理，只是读取到原数据，那么对于我们后期的操作是不利的，有办法解决吗？</p> <p><img src="images/image-20200924161814066.png" alt="image-20200924161814066"></p> <h3 id="module"><a href="#module" class="header-anchor">#</a> Module</h3> <p>前面要想实现日志数据的读取以及处理都是自己手动配置的，其实，在Filebeat中，有大量的Module，可以简化我们的配置，直接就可以使用，如下：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>./filebeat modules list
</code></pre></div><p>得到的列表如下所示</p> <div class="language-bash extra-class"><pre class="language-bash"><code>Disabled:
activemq
apache
auditd
aws
azure
barracuda
bluecoat
cef
checkpoint
cisco
coredns
crowdstrike
cylance
elasticsearch
envoyproxy
f5
fortinet
googlecloud
gsuite
haproxy
ibmmq
icinga
iis
imperva
infoblox
iptables
juniper
kafka
kibana
logstash
microsoft
misp
mongodb
mssql
mysql
nats
netflow
netscout
nginx
o365
okta
osquery
panw
postgresql
rabbitmq
radware
redis
santa
sonicwall
sophos
squid
suricata
system
tomcat
traefik
zeek
zscaler
</code></pre></div><p>可以看到，内置了很多的module，但是都没有启用，如果需要启用需要进行enable操作：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment">#启动</span>
./filebeat modules <span class="token builtin class-name">enable</span> nginx 
<span class="token comment">#禁用</span>
./filebeat modules disable nginx 
</code></pre></div><p>可以发现，nginx的module已经被启用。</p> <h4 id="nginx-module-配置"><a href="#nginx-module-配置" class="header-anchor">#</a> nginx module 配置</h4> <p>我们到下面的目录，就能看到module的配置了</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 进入到module目录</span>
<span class="token builtin class-name">cd</span> modules.d/
<span class="token comment">#查看文件</span>
<span class="token function">vim</span> nginx.yml.disabled
</code></pre></div><p>得到的文件内容如下所示</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># Module: nginx</span>
<span class="token comment"># Docs: https://www.elastic.co/guide/en/beats/filebeat/7.9/filebeat-module-nginx.html</span>

- module: nginx
  <span class="token comment"># Access logs</span>
  access:
    enabled: <span class="token boolean">true</span>
    <span class="token comment"># 添加日志文件</span>
    var.paths: <span class="token punctuation">[</span><span class="token string">&quot;/var/log/nginx/access.log*&quot;</span><span class="token punctuation">]</span>

    <span class="token comment"># Set custom paths for the log files. If left empty,</span>
    <span class="token comment"># Filebeat will choose the paths depending on your OS.</span>
    <span class="token comment">#var.paths:</span>

  <span class="token comment"># Error logs</span>
  error:
    enabled: <span class="token boolean">true</span>
    var.paths: <span class="token punctuation">[</span><span class="token string">&quot;/var/log/nginx/error.log*&quot;</span><span class="token punctuation">]</span>
</code></pre></div><h4 id="配置filebeat"><a href="#配置filebeat" class="header-anchor">#</a> 配置filebeat</h4> <p>我们需要修改刚刚的mogublog-nginx.yml文件，然后添加到我们的module</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
<span class="token key atrule">setup.template.settings</span><span class="token punctuation">:</span>
  <span class="token key atrule">index.number_of_shards</span><span class="token punctuation">:</span> <span class="token number">1</span>
<span class="token key atrule">output.elasticsearch</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;127.0.0.1:9200&quot;</span><span class="token punctuation">]</span>
<span class="token key atrule">filebeat.config.modules</span><span class="token punctuation">:</span>
  <span class="token key atrule">path</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>path.config<span class="token punctuation">}</span>/modules.d/<span class="token important">*.yml</span>
  <span class="token key atrule">reload.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
</code></pre></div><h4 id="测试"><a href="#测试" class="header-anchor">#</a> 测试</h4> <p>我们启动我们的filebeat</p> <div class="language-bash extra-class"><pre class="language-bash"><code>./filebeat -e -c itcast-nginx.yml
</code></pre></div><p>如果启动的时候发现出错了，错误如下所示，执行如图所示的脚本即可 【新版本的ES好像不会出现这个错误】</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment">#启动会出错，如下</span>
ERROR fileset/factory.go:142 Error loading pipeline: Error loading pipeline <span class="token keyword">for</span>
fileset nginx/access: This module requires the following Elasticsearch plugins:
ingest-user-agent, ingest-geoip. You can <span class="token function">install</span> them by running the following
commands on all the Elasticsearch nodes:
  <span class="token function">sudo</span> bin/elasticsearch-plugin <span class="token function">install</span> ingest-user-agent
  <span class="token function">sudo</span> bin/elasticsearch-plugin <span class="token function">install</span> ingest-geoip

</code></pre></div><p>启动成功后，能看到日志记录已经成功刷新进去了</p> <p><img src="images/image-20200924164750123.png" alt="image-20200924164750123"></p> <p>我们可以测试一下，刷新nginx页面，或者向错误日志中，插入数据</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">echo</span> <span class="token string">&quot;err&quot;</span> <span class="token operator">&gt;&gt;</span> error.log
</code></pre></div><p>能够看到，刚刚的记录已经成功插入了</p> <p><img src="images/image-20200924164927557.png" alt="image-20200924164927557"></p> <p>关于module的其它使用，可以参考文档：</p> <p>https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-modules.html</p> <h2 id="metricbeat"><a href="#metricbeat" class="header-anchor">#</a> Metricbeat</h2> <p><img src="images/image-20200924170741928.png" alt="image-20200924170741928"></p> <ul><li>定期收集操作系统或应用服务的指标数据</li> <li>存储到Elasticsearch中，进行实时分析</li></ul> <h3 id="metricbeat组成"><a href="#metricbeat组成" class="header-anchor">#</a> Metricbeat组成</h3> <p>Metricbeat有2部分组成，一部分是Module，另一个部分为Metricset</p> <ul><li>Module
<ul><li>收集的对象：如 MySQL、Redis、Nginx、操作系统等</li></ul></li> <li>Metricset
<ul><li>收集指标的集合：如 cpu、memory，network等</li></ul></li></ul> <p>以Redis Module为例：</p> <p><img src="images/image-20200924170958343.png" alt="image-20200924170958343"></p> <h3 id="下载-2"><a href="#下载-2" class="header-anchor">#</a> 下载</h3> <p>首先我们到<a href="https://www.elastic.co/cn/downloads/beats/metricbeat" target="_blank" rel="noopener noreferrer">官网<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，找到Metricbeat进行下载</p> <p><img src="images/image-20200924171232384.png" alt="image-20200924171232384"></p> <p>下载完成后，我们通过xftp工具，移动到指定的目录下</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 移动到该目录下</span>
<span class="token builtin class-name">cd</span> /soft/beats
<span class="token comment"># 解压文件</span>
<span class="token function">tar</span> -zxvf 
<span class="token comment"># 修改文件名</span>
<span class="token function">mv</span>  metricbeat
</code></pre></div><p>然后修改配置文件</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">vim</span> metricbeat.yml
</code></pre></div><p>添加如下内容</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">metricbeat.config.modules</span><span class="token punctuation">:</span>
  <span class="token key atrule">path</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>path.config<span class="token punctuation">}</span>/modules.d/<span class="token important">*.yml</span>
  <span class="token key atrule">reload.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">setup.template.settings</span><span class="token punctuation">:</span>
  <span class="token key atrule">index.number_of_shards</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">index.codec</span><span class="token punctuation">:</span> best_compression
<span class="token key atrule">setup.kibana</span><span class="token punctuation">:</span>
<span class="token key atrule">output.elasticsearch</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>&quot;&quot;127.0.0.1<span class="token punctuation">:</span>9200&quot;<span class="token punctuation">]</span>
<span class="token key atrule">processors</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">add_host_metadata</span><span class="token punctuation">:</span> <span class="token null important">~</span>
  <span class="token punctuation">-</span> <span class="token key atrule">add_cloud_metadata</span><span class="token punctuation">:</span> <span class="token null important">~</span>
</code></pre></div><p>默认会指定的配置文件，就是在</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token variable">${path.config}</span>/modules.d/*.yml
</code></pre></div><p>也就是 system.yml文件，我们也可以自行开启其它的收集</p> <h3 id="启动-2"><a href="#启动-2" class="header-anchor">#</a> 启动</h3> <p>在配置完成后，我们通过如下命令启动即可</p> <div class="language-bash extra-class"><pre class="language-bash"><code>./metricbeat -e
</code></pre></div><p>在ELasticsearch中可以看到，系统的一些指标数据已经写入进去了：</p> <p><img src="images/image-20200924171839291.png" alt="image-20200924171839291"></p> <h3 id="system-module配置"><a href="#system-module配置" class="header-anchor">#</a> system module配置</h3> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token punctuation">-</span> <span class="token key atrule">module</span><span class="token punctuation">:</span> system
  <span class="token key atrule">period</span><span class="token punctuation">:</span> 10s  <span class="token comment"># 采集的频率，每10秒采集一次</span>
  <span class="token key atrule">metricsets</span><span class="token punctuation">:</span>  <span class="token comment"># 采集的内容</span>
    <span class="token punctuation">-</span> cpu
    <span class="token punctuation">-</span> load
    <span class="token punctuation">-</span> memory
    <span class="token punctuation">-</span> network
    <span class="token punctuation">-</span> process
    <span class="token punctuation">-</span> process_summary
</code></pre></div><h3 id="metricbeat-module"><a href="#metricbeat-module" class="header-anchor">#</a> Metricbeat Module</h3> <p>Metricbeat Module的用法和我们之前学的filebeat的用法差不多</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment">#查看列表</span>
./metricbeat modules list 
</code></pre></div><p>能够看到对应的列表</p> <div class="language-bash extra-class"><pre class="language-bash"><code>Enabled:
system <span class="token comment">#默认启用</span>

Disabled:
aerospike
apache
ceph
couchbase
docker
dropwizard
elasticsearch
envoyproxy
etcd
golang
graphite
haproxy
http
jolokia
kafka
kibana
kubernetes
kvm
logstash
memcached
mongodb
munin
mysql
nginx
php_fpm
postgresql
prometheus
rabbitmq
redis
traefik
uwsgi
vsphere
windows
</code></pre></div><h3 id="nginx-module"><a href="#nginx-module" class="header-anchor">#</a> Nginx Module</h3> <h4 id="开启nginx-module"><a href="#开启nginx-module" class="header-anchor">#</a> 开启Nginx Module</h4> <p>在nginx中，需要开启状态查询，才能查询到指标数据。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment">#重新编译nginx</span>
./configure --prefix<span class="token operator">=</span>/usr/local/nginx --with-http_stub_status_module
<span class="token function">make</span>
<span class="token function">make</span> <span class="token function">install</span>

./nginx -V <span class="token comment">#查询版本信息</span>
nginx version: nginx/1.11.6
built by gcc <span class="token number">4.4</span>.7 <span class="token number">20120313</span> <span class="token punctuation">(</span>Red Hat <span class="token number">4.4</span>.7-23<span class="token punctuation">)</span> <span class="token punctuation">(</span>GCC<span class="token punctuation">)</span>
configure arguments: --prefix<span class="token operator">=</span>/usr/local/nginx --with-http_stub_status_module

<span class="token comment">#配置nginx</span>
<span class="token function">vim</span> nginx.conf
location /nginx-status <span class="token punctuation">{</span>
    stub_status on<span class="token punctuation">;</span>
    access_log off<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment"># 重启nginx</span>
./nginx -s reload
</code></pre></div><p>测试</p> <p><img src="images/image-20200924172317526.png" alt="image-20200924172317526"></p> <p>结果说明：</p> <ul><li>Active connections：正在处理的活动连接数</li> <li>server accepts handled requests
<ul><li>第一个 server 表示Nginx启动到现在共处理了9个连接</li> <li>第二个 accepts 表示Nginx启动到现在共成功创建 9 次握手</li> <li>第三个 handled requests 表示总共处理了 21 次请求</li> <li>请求丢失数 = 握手数 - 连接数 ，可以看出目前为止没有丢失请求</li></ul></li> <li>Reading: 0 Writing: 1 Waiting: 1
<ul><li>Reading：Nginx 读取到客户端的 Header 信息数</li> <li>Writing：Nginx 返回给客户端 Header 信息数</li> <li>Waiting：Nginx 已经处理完正在等候下一次请求指令的驻留链接（开启keep-alive的情况下，这个值等于
Active - (Reading+Writing)）</li></ul></li></ul> <h3 id="配置nginx-module"><a href="#配置nginx-module" class="header-anchor">#</a> 配置nginx module</h3> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment">#启用redis module</span>
./metricbeat modules <span class="token builtin class-name">enable</span> nginx

<span class="token comment">#修改redis module配置</span>
<span class="token function">vim</span> modules.d/nginx.yml
</code></pre></div><p>然后修改下面的信息</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># Module: nginx</span>
<span class="token comment"># Docs: https://www.elastic.co/guide/en/beats/metricbeat/6.5/metricbeat-modulenginx.</span>
html
  - module: nginx
<span class="token comment">#metricsets:</span>
<span class="token comment"># - stubstatus</span>
  period: 10s
<span class="token comment"># Nginx hosts</span>
  hosts: <span class="token punctuation">[</span><span class="token string">&quot;http://127.0.0.1&quot;</span><span class="token punctuation">]</span>
<span class="token comment"># Path to server status. Default server-status</span>
  server_status_path: <span class="token string">&quot;nginx-status&quot;</span>
<span class="token comment">#username: &quot;user&quot;</span>
<span class="token comment">#password: &quot;secret&quot;</span>
</code></pre></div><p>修改完成后，启动nginx</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment">#启动</span>
./metricbeat -e
</code></pre></div><h3 id="测试-2"><a href="#测试-2" class="header-anchor">#</a> 测试</h3> <p>我们能看到，我们的nginx数据已经成功的采集到我们的系统中了</p> <p><img src="images/image-20200924173058267.png" alt="image-20200924173058267"></p> <p>可以看到，nginx的指标数据已经写入到了Elasticsearch。</p> <p>更多的Module使用参见官方文档：</p> <p>https://www.elastic.co/guide/en/beats/metricbeat/current/metricbeat-modules.html</p> <h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <p><a href="https://www.cnblogs.com/cjsblog/p/9495024.html" target="_blank" rel="noopener noreferrer">Filebeat 模块与配置<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://www.bilibili.com/video/BV1iJ411c7Az" target="_blank" rel="noopener noreferrer">Elastic Stack（ELK）从入门到实践<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">2/5/2023, 4:38:02 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/db/nosql/elasticsearch/elasticsearch1.html" class="prev">
        ElasticSearch
      </a></span> <span class="next"><a href="/blog/db/nosql/elasticsearch/elasticsearch3.html">
        Kibana入门
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/blog/assets/js/app.96a63ad2.js" defer></script><script src="/blog/assets/js/2.e671b9b2.js" defer></script><script src="/blog/assets/js/3.be9bea65.js" defer></script><script src="/blog/assets/js/19.c6e110df.js" defer></script>
  </body>
</html>
