<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Oracle | Tang&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/blog/TB5.PNG">
    <meta name="description" content="This is a blog.">
    
    <link rel="preload" href="/blog/assets/css/0.styles.389ed919.css" as="style"><link rel="preload" href="/blog/assets/js/app.96a63ad2.js" as="script"><link rel="preload" href="/blog/assets/js/2.e671b9b2.js" as="script"><link rel="preload" href="/blog/assets/js/3.be9bea65.js" as="script"><link rel="preload" href="/blog/assets/js/30.724cfbb6.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.6769ccf0.js"><link rel="prefetch" href="/blog/assets/js/11.46df150a.js"><link rel="prefetch" href="/blog/assets/js/12.e78943d6.js"><link rel="prefetch" href="/blog/assets/js/13.5d361c1d.js"><link rel="prefetch" href="/blog/assets/js/14.13534fd9.js"><link rel="prefetch" href="/blog/assets/js/15.b21fe2e3.js"><link rel="prefetch" href="/blog/assets/js/16.bf5062c1.js"><link rel="prefetch" href="/blog/assets/js/17.65346b85.js"><link rel="prefetch" href="/blog/assets/js/18.6fb1bdc2.js"><link rel="prefetch" href="/blog/assets/js/19.c6e110df.js"><link rel="prefetch" href="/blog/assets/js/20.4a33f06a.js"><link rel="prefetch" href="/blog/assets/js/21.28170e84.js"><link rel="prefetch" href="/blog/assets/js/22.9358a818.js"><link rel="prefetch" href="/blog/assets/js/23.136a0f54.js"><link rel="prefetch" href="/blog/assets/js/24.499aeaaf.js"><link rel="prefetch" href="/blog/assets/js/25.3cff72a1.js"><link rel="prefetch" href="/blog/assets/js/26.4ee8c52f.js"><link rel="prefetch" href="/blog/assets/js/27.6e099c82.js"><link rel="prefetch" href="/blog/assets/js/28.bfc3427b.js"><link rel="prefetch" href="/blog/assets/js/29.ce801df4.js"><link rel="prefetch" href="/blog/assets/js/31.ffd0a663.js"><link rel="prefetch" href="/blog/assets/js/32.feba734b.js"><link rel="prefetch" href="/blog/assets/js/33.e8d22227.js"><link rel="prefetch" href="/blog/assets/js/34.a12f435a.js"><link rel="prefetch" href="/blog/assets/js/35.31d4b272.js"><link rel="prefetch" href="/blog/assets/js/36.a6d04eab.js"><link rel="prefetch" href="/blog/assets/js/37.d8aae5c8.js"><link rel="prefetch" href="/blog/assets/js/38.2d9e0b46.js"><link rel="prefetch" href="/blog/assets/js/39.f9bd73de.js"><link rel="prefetch" href="/blog/assets/js/4.850a33ae.js"><link rel="prefetch" href="/blog/assets/js/40.5ef065c5.js"><link rel="prefetch" href="/blog/assets/js/41.014df883.js"><link rel="prefetch" href="/blog/assets/js/42.199ac029.js"><link rel="prefetch" href="/blog/assets/js/43.69e01de9.js"><link rel="prefetch" href="/blog/assets/js/44.b00eed2f.js"><link rel="prefetch" href="/blog/assets/js/45.f676a314.js"><link rel="prefetch" href="/blog/assets/js/46.d76b7b8a.js"><link rel="prefetch" href="/blog/assets/js/47.fa6622ba.js"><link rel="prefetch" href="/blog/assets/js/48.629ae724.js"><link rel="prefetch" href="/blog/assets/js/49.3f36b8cf.js"><link rel="prefetch" href="/blog/assets/js/5.c1ab3a44.js"><link rel="prefetch" href="/blog/assets/js/50.6429bdc0.js"><link rel="prefetch" href="/blog/assets/js/51.b7cb8687.js"><link rel="prefetch" href="/blog/assets/js/52.7360a167.js"><link rel="prefetch" href="/blog/assets/js/53.fb5fcabb.js"><link rel="prefetch" href="/blog/assets/js/54.f5ac5958.js"><link rel="prefetch" href="/blog/assets/js/55.592b0348.js"><link rel="prefetch" href="/blog/assets/js/56.d17f3acb.js"><link rel="prefetch" href="/blog/assets/js/57.11aeb3ed.js"><link rel="prefetch" href="/blog/assets/js/58.1b2f9f8b.js"><link rel="prefetch" href="/blog/assets/js/59.c5633b7a.js"><link rel="prefetch" href="/blog/assets/js/6.0106dfd1.js"><link rel="prefetch" href="/blog/assets/js/60.230b2314.js"><link rel="prefetch" href="/blog/assets/js/61.f9cb1ad6.js"><link rel="prefetch" href="/blog/assets/js/62.92f2597d.js"><link rel="prefetch" href="/blog/assets/js/63.25fe8e93.js"><link rel="prefetch" href="/blog/assets/js/64.08acc4bc.js"><link rel="prefetch" href="/blog/assets/js/65.cba08f56.js"><link rel="prefetch" href="/blog/assets/js/66.2aff3910.js"><link rel="prefetch" href="/blog/assets/js/67.23dfb624.js"><link rel="prefetch" href="/blog/assets/js/68.7e1a9696.js"><link rel="prefetch" href="/blog/assets/js/69.127d4ccb.js"><link rel="prefetch" href="/blog/assets/js/7.34cfb431.js"><link rel="prefetch" href="/blog/assets/js/70.cb7a9ca8.js"><link rel="prefetch" href="/blog/assets/js/71.fc5012c0.js"><link rel="prefetch" href="/blog/assets/js/72.04308961.js"><link rel="prefetch" href="/blog/assets/js/73.3b80efd9.js"><link rel="prefetch" href="/blog/assets/js/74.009897a1.js"><link rel="prefetch" href="/blog/assets/js/75.00bb0c95.js"><link rel="prefetch" href="/blog/assets/js/76.0b9619cc.js"><link rel="prefetch" href="/blog/assets/js/77.3cdf8f24.js"><link rel="prefetch" href="/blog/assets/js/78.2db1c727.js"><link rel="prefetch" href="/blog/assets/js/79.342c3faa.js"><link rel="prefetch" href="/blog/assets/js/8.51e80c5b.js"><link rel="prefetch" href="/blog/assets/js/80.0439653b.js"><link rel="prefetch" href="/blog/assets/js/81.6c0e9802.js"><link rel="prefetch" href="/blog/assets/js/82.e6e1608a.js"><link rel="prefetch" href="/blog/assets/js/83.39a82281.js"><link rel="prefetch" href="/blog/assets/js/84.4415141b.js"><link rel="prefetch" href="/blog/assets/js/85.00b63f10.js"><link rel="prefetch" href="/blog/assets/js/86.1581db60.js"><link rel="prefetch" href="/blog/assets/js/87.4c47bbc2.js"><link rel="prefetch" href="/blog/assets/js/88.10af48c1.js"><link rel="prefetch" href="/blog/assets/js/89.84840655.js"><link rel="prefetch" href="/blog/assets/js/9.c76e1545.js"><link rel="prefetch" href="/blog/assets/js/90.574990da.js"><link rel="prefetch" href="/blog/assets/js/91.a1094788.js"><link rel="prefetch" href="/blog/assets/js/92.7070acb6.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.389ed919.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/TB5.PNG" alt="Tang's Blog" class="logo"> <span class="site-name can-hide">Tang's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术笔记" class="dropdown-title"><span class="title">技术笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="技术笔记" class="mobile-dropdown-title"><span class="title">技术笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/java/" class="nav-link">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/blog/frontend/" class="nav-link">
  前端
</a></li><li class="dropdown-item"><!----> <a href="/blog/db/" class="nav-link router-link-active">
  DB
</a></li><li class="dropdown-item"><!----> <a href="/blog/microservice/" class="nav-link">
  微服务
</a></li><li class="dropdown-item"><!----> <a href="/blog/distribution/" class="nav-link">
  分布式
</a></li><li class="dropdown-item"><!----> <a href="/blog/bigdata/" class="nav-link">
  大数据
</a></li><li class="dropdown-item"><!----> <a href="/blog/devops/" class="nav-link">
  DevOps
</a></li><li class="dropdown-item"><!----> <a href="/blog/newlanguage/" class="nav-link">
  新语言
</a></li><li class="dropdown-item"><!----> <a href="/blog/othertool/" class="nav-link">
  其他工具
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/readbook/" class="nav-link">
  读书分享
</a></li><li class="dropdown-item"><!----> <a href="/blog/guitar/" class="nav-link">
  吉他谱
</a></li><li class="dropdown-item"><!----> <a href="/blog/food/" class="nav-link">
  饮食
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术笔记" class="dropdown-title"><span class="title">技术笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="技术笔记" class="mobile-dropdown-title"><span class="title">技术笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/java/" class="nav-link">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/blog/frontend/" class="nav-link">
  前端
</a></li><li class="dropdown-item"><!----> <a href="/blog/db/" class="nav-link router-link-active">
  DB
</a></li><li class="dropdown-item"><!----> <a href="/blog/microservice/" class="nav-link">
  微服务
</a></li><li class="dropdown-item"><!----> <a href="/blog/distribution/" class="nav-link">
  分布式
</a></li><li class="dropdown-item"><!----> <a href="/blog/bigdata/" class="nav-link">
  大数据
</a></li><li class="dropdown-item"><!----> <a href="/blog/devops/" class="nav-link">
  DevOps
</a></li><li class="dropdown-item"><!----> <a href="/blog/newlanguage/" class="nav-link">
  新语言
</a></li><li class="dropdown-item"><!----> <a href="/blog/othertool/" class="nav-link">
  其他工具
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/readbook/" class="nav-link">
  读书分享
</a></li><li class="dropdown-item"><!----> <a href="/blog/guitar/" class="nav-link">
  吉他谱
</a></li><li class="dropdown-item"><!----> <a href="/blog/food/" class="nav-link">
  饮食
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>关系型</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/db/sql/mysql.html" class="sidebar-link">Mysql</a></li><li><a href="/blog/db/sql/oracle.html" aria-current="page" class="active sidebar-link">Oracle</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/db/sql/oracle.html#trigger" class="sidebar-link">Trigger</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/db/sql/oracle.html#概述" class="sidebar-link">概述</a></li><li class="sidebar-sub-header"><a href="/blog/db/sql/oracle.html#触发器语法及关键字" class="sidebar-link">触发器语法及关键字</a></li><li class="sidebar-sub-header"><a href="/blog/db/sql/oracle.html#安全性检查" class="sidebar-link">安全性检查</a></li><li class="sidebar-sub-header"><a href="/blog/db/sql/oracle.html#数据确认" class="sidebar-link">数据确认</a></li><li class="sidebar-sub-header"><a href="/blog/db/sql/oracle.html#数据库审计" class="sidebar-link">数据库审计</a></li><li class="sidebar-sub-header"><a href="/blog/db/sql/oracle.html#数据的备份和同步" class="sidebar-link">数据的备份和同步</a></li><li class="sidebar-sub-header"><a href="/blog/db/sql/oracle.html#其他" class="sidebar-link">其他</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>非关系型</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>Redis</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/db/nosql/redis/redis.html" class="sidebar-link">Redis</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Elastic Stack</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Neo4j</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Mongodb</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>HBase</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>TimeSeries</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>分布式数据库</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/db/distributed/fercar.html" class="sidebar-link">Fercar 分布式事务</a></li><li><a href="/blog/db/distributed/sharding.html" class="sidebar-link">ShardingSphere 分库分表中间件</a></li><li><a href="/blog/db/distributed/tidb.html" class="sidebar-link">TiDB</a></li><li><a href="/blog/db/distributed/oceanbase.html" class="sidebar-link">OceanBase</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="oracle"><a href="#oracle" class="header-anchor">#</a> Oracle</h1> <h2 id="trigger"><a href="#trigger" class="header-anchor">#</a> Trigger</h2> <blockquote><p>参考：https://blog.csdn.net/gdkyxy2013/article/details/118896816</p></blockquote> <h3 id="概述"><a href="#概述" class="header-anchor">#</a> 概述</h3> <h4 id="触发器是什么"><a href="#触发器是什么" class="header-anchor">#</a> 触发器是什么？</h4> <p>数据库触发器是一个与表相关联的，存储的PL/SQL 语句。每当一个特定的数据操作语句（insert update delete）在指定的表上发出时，Oracle自动执行触发器中定义的语句序列。
（当触发条件成立时，其语句就会自动执行）</p> <h4 id="触发器有什么用"><a href="#触发器有什么用" class="header-anchor">#</a> 触发器有什么用？</h4> <p>保护数据的安全，监视对数据的各种操作，如
'日志记录': 对重要表的 '修改' 进行记录</p> <h4 id="触发器和存储过程的区别"><a href="#触发器和存储过程的区别" class="header-anchor">#</a> 触发器和存储过程的区别？</h4> <p>主要区别：'调用运行方式不同'</p> <ol><li>存储过程: '用户'、'应用程序'、'触发器' 来调用</li> <li>触发器:   '自动执行'（满足 '触发条件'），与其它无关</li></ol> <h3 id="触发器语法及关键字"><a href="#触发器语法及关键字" class="header-anchor">#</a> 触发器语法及关键字</h3> <p>举个简单的例子：
当员工表中新增一条记录后，自动打印“成功插入新员工”</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> <span class="token keyword">trigger</span> insertStaffHint
 <span class="token keyword">after</span> <span class="token keyword">insert</span> <span class="token keyword">on</span> xgj_test 
 <span class="token keyword">for each row</span>
<span class="token keyword">declare</span>
 <span class="token comment">-- local variables here</span>
<span class="token keyword">begin</span>
 dbms_output<span class="token punctuation">.</span>put_line<span class="token punctuation">(</span><span class="token string">'新增员工成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">end</span> insertStaffHint<span class="token punctuation">;</span>
</code></pre></div><br> <p>触发器语法</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token punctuation">[</span><span class="token operator">OR</span> <span class="token keyword">REPLACE</span><span class="token punctuation">]</span> <span class="token keyword">TRIGGER</span> trigger_name
{BEFORE <span class="token operator">|</span> <span class="token keyword">AFTER</span> }
{<span class="token keyword">INSERT</span> <span class="token operator">|</span> <span class="token keyword">DELETE</span> <span class="token operator">|</span> <span class="token keyword">UPDATE</span> <span class="token punctuation">[</span><span class="token keyword">OF</span> <span class="token keyword">column</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token keyword">column</span> …<span class="token punctuation">]</span><span class="token punctuation">]</span>}
<span class="token punctuation">[</span><span class="token operator">OR</span> {<span class="token keyword">INSERT</span> <span class="token operator">|</span> <span class="token keyword">DELETE</span> <span class="token operator">|</span> <span class="token keyword">UPDATE</span> <span class="token punctuation">[</span><span class="token keyword">OF</span> <span class="token keyword">column</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token keyword">column</span> …<span class="token punctuation">]</span><span class="token punctuation">]</span>}<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
<span class="token keyword">ON</span> <span class="token punctuation">[</span><span class="token keyword">schema</span><span class="token punctuation">.</span><span class="token punctuation">]</span>table_name <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token keyword">schema</span><span class="token punctuation">.</span><span class="token punctuation">]</span>view_name
<span class="token punctuation">[</span>REFERENCING {OLD <span class="token punctuation">[</span><span class="token keyword">AS</span><span class="token punctuation">]</span> old <span class="token operator">|</span> NEW <span class="token punctuation">[</span><span class="token keyword">AS</span><span class="token punctuation">]</span> new<span class="token operator">|</span> PARENT <span class="token keyword">as</span> parent}<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token keyword">FOR EACH ROW</span> <span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token keyword">WHEN</span> condition<span class="token punctuation">]</span>
PL<span class="token operator">/</span>SQL_BLOCK <span class="token operator">|</span> <span class="token keyword">CALL</span> procedure_name<span class="token punctuation">;</span>
</code></pre></div><h4 id="before-和after"><a href="#before-和after" class="header-anchor">#</a> BEFORE 和AFTER</h4> <p>指出触发器的触发时序分别为前触发和后触发方式，前触发是在执行触发事件之前触发当前所创建的触发器，后触发是在执行触发事件之后触发当前所创建的触发器。</p> <h4 id="for-each-row"><a href="#for-each-row" class="header-anchor">#</a> FOR EACH ROW</h4> <p>说明触发器为行触发器。
行触发器和语句触发器的区别表现在：行触发器要求当一个DML语句操走影响数据库中的多行数据时，对于其中的每个数据行，只要它们符合触发约束条件，均激活一次触发器；而语句触发器将整个语句操作作为触发事件，当它符合约束条件时，激活一次触发器。
当省略FOR EACH ROW 选项时，BEFORE 和AFTER 触发器为语句触发器，而INSTEAD OF 触发器则只能为行触发器。</p> <h4 id="referencing"><a href="#referencing" class="header-anchor">#</a> REFERENCING</h4> <p>REFERENCING子句说明相关名称，在行触发器的PL/SQL块和WHEN子句中可以使用相关名称参照当前的新、旧列值，默认的相关名称分别为OLD和NEW。触发器的PL/SQL块中应用相关名称时，必须在它们之前加冒号(😃，但在WHEN子句中则不能加冒号。</p> <h4 id="when"><a href="#when" class="header-anchor">#</a> WHEN</h4> <p>WHEN子句说明触发约束条件。Condition 为一个逻辑表达时，其中必须包含相关名称，而不能包含查询语句，也不能调用PL/SQL 函数。WHEN 子句指定的触发约束条件只能用在BEFORE 和AFTER 行触发器中，不能用在INSTEAD OF 行触发器和其它类型的触发器中。</p> <p>当一个基表被修改( INSERT, UPDATE, DELETE)时要执行的存储过程，执行时根据其所依附的基表改动而自动触发，因此与应用程序无关，用数据库触发器可以保证数据的一致性和完整性。</p> <h3 id="安全性检查"><a href="#安全性检查" class="header-anchor">#</a> 安全性检查</h3> <p>禁止在非工作时间插入数据</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">/**
非工作时间（星球六 星期日， 非9点~18点的区间）
禁止写入数据
 
首先要搞清楚： 触发器的类型--语句级触发器。
不管插入了多少条数据，没有必要对每一行数据都进行校验，只要不在这个时间段内，都不让插入。
*/</span>
<span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> <span class="token keyword">trigger</span> addStafffCheck
 before <span class="token keyword">insert</span> <span class="token keyword">on</span> xgj_test 
 
<span class="token keyword">declare</span>
 <span class="token comment">-- local variables here</span>
<span class="token keyword">begin</span>
 
 <span class="token keyword">if</span> to_char<span class="token punctuation">(</span>sysdate<span class="token punctuation">,</span> <span class="token string">'day'</span><span class="token punctuation">)</span> <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'星期六'</span><span class="token punctuation">,</span> <span class="token string">'星期日'</span><span class="token punctuation">)</span> <span class="token operator">or</span>
 to_number<span class="token punctuation">(</span>to_char<span class="token punctuation">(</span>sysdate<span class="token punctuation">,</span> <span class="token string">'hh24'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token operator">between</span> <span class="token number">9</span> <span class="token operator">and</span> <span class="token number">18</span> <span class="token keyword">then</span>
 <span class="token comment">--禁止insert </span>
 raise_application_error<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">20001</span><span class="token punctuation">,</span><span class="token string">'非工作时间禁止插入数据'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>
<span class="token keyword">end</span> addStafffCheck<span class="token punctuation">;</span>
</code></pre></div><p>raise_application_error用于在plsql使用程序中自定义不正确消息。该异常只在数据库端的子程序（流程、函数、包、触发器）中运用，而无法在匿名块和客户端的子程序中运用。语法为raise_application_error(error_number,message[,[truefalse]])。其中error_number用于定义不正确号，该不正确号必须在-20000到-20999之间的负整数；message用于指定不正确消息，并且该消息的长度无法超过2048字节。</p> <p>运行结果：</p> <p><img src="/blog/db/sql/oracle/trigger/trigger1.jpeg" alt="trigger1"></p> <h3 id="数据确认"><a href="#数据确认" class="header-anchor">#</a> 数据确认</h3> <p>涨薪后的工资应该大于涨薪前的工资</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">/**
涨后的薪水不能低于涨前的薪水
 
1 :old 和 :new 代表同一条记录
2 :old 代表操作该行之前，这一行的值
 :new 代表操作该行之后，这一行的值
*/</span>
<span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> <span class="token keyword">trigger</span> checkSalary
 before <span class="token keyword">update</span>
 <span class="token keyword">on</span> xgj_test 
 <span class="token keyword">for each row</span>
<span class="token keyword">declare</span>
 <span class="token comment">-- local variables here 没有变量声明的话，declare可以省略</span>
<span class="token keyword">begin</span>
 
 <span class="token comment">--- if 涨后的薪水 &lt; 涨前的薪水 then 如何表示呢 ？</span>
 <span class="token keyword">if</span> :new<span class="token punctuation">.</span>sal <span class="token operator">&lt;</span> :old<span class="token punctuation">.</span>sal <span class="token keyword">then</span>
 
 raise_application_error<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">20002</span><span class="token punctuation">,</span><span class="token string">'涨后的薪水:'</span><span class="token operator">||</span> :new<span class="token punctuation">.</span>sal <span class="token operator">||</span><span class="token string">'小于涨前的薪水：'</span><span class="token operator">||</span>:old<span class="token punctuation">.</span>sal<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>
<span class="token keyword">end</span> checkSalary<span class="token punctuation">;</span>

</code></pre></div><p>运行结果：</p> <p><img src="/blog/db/sql/oracle/trigger/trigger2.jpeg" alt="trigger2"></p> <h3 id="数据库审计"><a href="#数据库审计" class="header-anchor">#</a> 数据库审计</h3> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> xgj_record<span class="token punctuation">(</span>info varchar2<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> <span class="token keyword">trigger</span> addrecord
 <span class="token keyword">after</span> <span class="token keyword">update</span>
 <span class="token keyword">on</span> xgj_test 
 <span class="token keyword">for each row</span>
<span class="token keyword">declare</span>
 <span class="token comment">-- local variables here</span>
<span class="token keyword">begin</span>
 
 <span class="token keyword">if</span> :new<span class="token punctuation">.</span>sal <span class="token operator">&gt;</span> <span class="token number">6000</span> <span class="token keyword">then</span>
 <span class="token keyword">insert</span> <span class="token keyword">into</span> xgj_record <span class="token keyword">values</span><span class="token punctuation">(</span>:new<span class="token punctuation">.</span>sal <span class="token operator">||</span><span class="token string">'-'</span><span class="token operator">||</span> :new<span class="token punctuation">.</span>username <span class="token operator">||</span><span class="token string">'-'</span><span class="token operator">||</span> :new<span class="token punctuation">.</span>job<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>
 
<span class="token keyword">end</span> addrecord<span class="token punctuation">;</span>
</code></pre></div><p>运行结果：</p> <p><img src="/blog/db/sql/oracle/trigger/trigger3.jpeg" alt="trigger3"></p> <h3 id="数据的备份和同步"><a href="#数据的备份和同步" class="header-anchor">#</a> 数据的备份和同步</h3> <p>当给员工涨完工资后，自动备份到备份表中</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> xgj_test_bak <span class="token keyword">as</span> <span class="token keyword">select</span> <span class="token operator">*</span>　<span class="token keyword">from</span> xgj_test <span class="token punctuation">;</span>
 
<span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> <span class="token keyword">trigger</span> databack
 <span class="token keyword">after</span> <span class="token keyword">update</span>
 <span class="token keyword">on</span> xgj_test
 <span class="token keyword">for each row</span> 
 
<span class="token keyword">begin</span>
 
 <span class="token keyword">update</span> xgj_test_bak <span class="token keyword">set</span> sal <span class="token operator">=</span> :new<span class="token punctuation">.</span>sal <span class="token keyword">where</span> username <span class="token operator">=</span> :new<span class="token punctuation">.</span>username <span class="token punctuation">;</span>
 
<span class="token keyword">end</span> databack<span class="token punctuation">;</span>
</code></pre></div><p>运行结果：</p> <p><img src="/blog/db/sql/oracle/trigger/trigger4.jpeg" alt="trigger4"></p> <h3 id="其他"><a href="#其他" class="header-anchor">#</a> 其他</h3> <h4 id="建立一个触发器-当职工表-emp-表被删除一条记录时-把被删除记录写到职工表删除日志表中去"><a href="#建立一个触发器-当职工表-emp-表被删除一条记录时-把被删除记录写到职工表删除日志表中去" class="header-anchor">#</a> 建立一个触发器, 当职工表 emp 表被删除一条记录时，把被删除记录写到职工表删除日志表中去</h4> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> emp_his <span class="token keyword">AS</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> EMP <span class="token keyword">WHERE</span> <span class="token number">1</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">TRIGGER</span> tr_del_emp
 BEFORE <span class="token keyword">DELETE</span> <span class="token comment">--指定触发时机为删除操作前触发</span>
 <span class="token keyword">ON</span> scott<span class="token punctuation">.</span>emp
 <span class="token keyword">FOR EACH ROW</span> <span class="token comment">--说明创建的是行级触发器</span>
<span class="token keyword">BEGIN</span>
 <span class="token comment">--将修改前数据插入到日志记录表 del_emp ,以供监督使用。</span>
 <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> emp_his<span class="token punctuation">(</span>deptno <span class="token punctuation">,</span> empno<span class="token punctuation">,</span> ename <span class="token punctuation">,</span> job <span class="token punctuation">,</span>mgr <span class="token punctuation">,</span> sal <span class="token punctuation">,</span> comm <span class="token punctuation">,</span> hiredate <span class="token punctuation">)</span>
 <span class="token keyword">VALUES</span><span class="token punctuation">(</span> :old<span class="token punctuation">.</span>deptno<span class="token punctuation">,</span> :old<span class="token punctuation">.</span>empno<span class="token punctuation">,</span> :old<span class="token punctuation">.</span>ename <span class="token punctuation">,</span> :old<span class="token punctuation">.</span>job<span class="token punctuation">,</span>:old<span class="token punctuation">.</span>mgr<span class="token punctuation">,</span> :old<span class="token punctuation">.</span>sal<span class="token punctuation">,</span> :old<span class="token punctuation">.</span>comm<span class="token punctuation">,</span> :old<span class="token punctuation">.</span>hiredate <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
<span class="token keyword">DELETE</span> emp <span class="token keyword">WHERE</span> empno<span class="token operator">=</span><span class="token number">7788</span><span class="token punctuation">;</span>
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> emp_his<span class="token punctuation">;</span>
<span class="token keyword">DROP</span> <span class="token keyword">TRIGGER</span> del_emp<span class="token punctuation">;</span>
</code></pre></div><h4 id="限定只对部门号为80的记录进行行触发器操作"><a href="#限定只对部门号为80的记录进行行触发器操作" class="header-anchor">#</a> 限定只对部门号为80的记录进行行触发器操作</h4> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">TRIGGER</span> tr_emp_sal_comm
BEFORE <span class="token keyword">UPDATE</span> <span class="token keyword">OF</span> salary<span class="token punctuation">,</span> commission_pct
 <span class="token operator">OR</span> <span class="token keyword">DELETE</span>
<span class="token keyword">ON</span> HR<span class="token punctuation">.</span>employees
<span class="token keyword">FOR EACH ROW</span>
<span class="token keyword">WHEN</span> <span class="token punctuation">(</span>old<span class="token punctuation">.</span>department_id <span class="token operator">=</span> <span class="token number">80</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
 <span class="token keyword">CASE</span>
 <span class="token keyword">WHEN</span> UPDATING <span class="token punctuation">(</span><span class="token string">'salary'</span><span class="token punctuation">)</span> <span class="token keyword">THEN</span>
 <span class="token keyword">IF</span> :NEW<span class="token punctuation">.</span>salary <span class="token operator">&lt;</span> :old<span class="token punctuation">.</span>salary <span class="token keyword">THEN</span>
 
  RAISE_APPLICATION_ERROR<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">20001</span><span class="token punctuation">,</span> <span class="token string">'部门80的人员的工资不能降'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
 <span class="token keyword">WHEN</span> UPDATING <span class="token punctuation">(</span><span class="token string">'commission_pct'</span><span class="token punctuation">)</span> <span class="token keyword">THEN</span>
 
 <span class="token keyword">IF</span> :NEW<span class="token punctuation">.</span>commission_pct <span class="token operator">&lt;</span> :old<span class="token punctuation">.</span>commission_pct <span class="token keyword">THEN</span>
  RAISE_APPLICATION_ERROR<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">20002</span><span class="token punctuation">,</span> <span class="token string">'部门80的人员的奖金不能降'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
 <span class="token keyword">WHEN</span> DELETING <span class="token keyword">THEN</span>
  RAISE_APPLICATION_ERROR<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">20003</span><span class="token punctuation">,</span> <span class="token string">'不能删除部门80的人员记录'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">END</span> <span class="token keyword">CASE</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="级联更新"><a href="#级联更新" class="header-anchor">#</a> 级联更新</h4> <p>在修改了主表regions中的region_id之后（AFTER），级联的、自动的更新子表countries表中原来在该地区的国家的region_id。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">TRIGGER</span> tr_reg_cou
<span class="token keyword">AFTER</span> <span class="token keyword">update</span> <span class="token keyword">OF</span> region_id
<span class="token keyword">ON</span> regions
<span class="token keyword">FOR EACH ROW</span>
<span class="token keyword">BEGIN</span>
 DBMS_OUTPUT<span class="token punctuation">.</span>PUT_LINE<span class="token punctuation">(</span><span class="token string">'旧的region_id值是'</span><span class="token operator">||</span>:old<span class="token punctuation">.</span>region_id
   <span class="token operator">||</span><span class="token string">'、新的region_id值是'</span><span class="token operator">||</span>:new<span class="token punctuation">.</span>region_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">UPDATE</span> countries <span class="token keyword">SET</span> region_id <span class="token operator">=</span> :new<span class="token punctuation">.</span>region_id
 <span class="token keyword">WHERE</span> region_id <span class="token operator">=</span> :old<span class="token punctuation">.</span>region_id<span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="触发器中调用过程"><a href="#触发器中调用过程" class="header-anchor">#</a> 触发器中调用过程</h4> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">PROCEDURE</span> add_job_history
 <span class="token punctuation">(</span> p_emp_id  job_history<span class="token punctuation">.</span>employee_id<span class="token operator">%</span><span class="token keyword">type</span>
 <span class="token punctuation">,</span> p_start_date job_history<span class="token punctuation">.</span>start_date<span class="token operator">%</span><span class="token keyword">type</span>
 <span class="token punctuation">,</span> p_end_date job_history<span class="token punctuation">.</span>end_date<span class="token operator">%</span><span class="token keyword">type</span>
 <span class="token punctuation">,</span> p_job_id  job_history<span class="token punctuation">.</span>job_id<span class="token operator">%</span><span class="token keyword">type</span>
 <span class="token punctuation">,</span> p_department_id job_history<span class="token punctuation">.</span>department_id<span class="token operator">%</span><span class="token keyword">type</span>
 <span class="token punctuation">)</span>
<span class="token operator">IS</span>
<span class="token keyword">BEGIN</span>
 <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> job_history <span class="token punctuation">(</span>employee_id<span class="token punctuation">,</span> start_date<span class="token punctuation">,</span> end_date<span class="token punctuation">,</span>
    job_id<span class="token punctuation">,</span> department_id<span class="token punctuation">)</span>
 <span class="token keyword">VALUES</span><span class="token punctuation">(</span>p_emp_id<span class="token punctuation">,</span> p_start_date<span class="token punctuation">,</span> p_end_date<span class="token punctuation">,</span> p_job_id<span class="token punctuation">,</span> p_department_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span> add_job_history<span class="token punctuation">;</span>
 
<span class="token comment">--创建触发器调用存储过程...</span>
<span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">TRIGGER</span> update_job_history
 <span class="token keyword">AFTER</span> <span class="token keyword">UPDATE</span> <span class="token keyword">OF</span> job_id<span class="token punctuation">,</span> department_id <span class="token keyword">ON</span> employees
 <span class="token keyword">FOR EACH ROW</span>
<span class="token keyword">BEGIN</span>
 add_job_history<span class="token punctuation">(</span>:old<span class="token punctuation">.</span>employee_id<span class="token punctuation">,</span> :old<span class="token punctuation">.</span>hire_date<span class="token punctuation">,</span> sysdate<span class="token punctuation">,</span>
   :old<span class="token punctuation">.</span>job_id<span class="token punctuation">,</span> :old<span class="token punctuation">.</span>department_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">4/14/2022, 6:13:37 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/db/sql/mysql.html" class="prev">
        Mysql
      </a></span> <span class="next"><a href="/blog/db/nosql/redis/redis.html">
        Redis
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/blog/assets/js/app.96a63ad2.js" defer></script><script src="/blog/assets/js/2.e671b9b2.js" defer></script><script src="/blog/assets/js/3.be9bea65.js" defer></script><script src="/blog/assets/js/30.724cfbb6.js" defer></script>
  </body>
</html>
