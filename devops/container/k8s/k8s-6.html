<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Kubernetes核心技术-Controller | Tang&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/blog/TB5.PNG">
    <meta name="description" content="This is a blog.">
    
    <link rel="preload" href="/blog/assets/css/0.styles.389ed919.css" as="style"><link rel="preload" href="/blog/assets/js/app.96a63ad2.js" as="script"><link rel="preload" href="/blog/assets/js/2.e671b9b2.js" as="script"><link rel="preload" href="/blog/assets/js/3.be9bea65.js" as="script"><link rel="preload" href="/blog/assets/js/47.fa6622ba.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.6769ccf0.js"><link rel="prefetch" href="/blog/assets/js/11.46df150a.js"><link rel="prefetch" href="/blog/assets/js/12.e78943d6.js"><link rel="prefetch" href="/blog/assets/js/13.5d361c1d.js"><link rel="prefetch" href="/blog/assets/js/14.13534fd9.js"><link rel="prefetch" href="/blog/assets/js/15.b21fe2e3.js"><link rel="prefetch" href="/blog/assets/js/16.bf5062c1.js"><link rel="prefetch" href="/blog/assets/js/17.65346b85.js"><link rel="prefetch" href="/blog/assets/js/18.6fb1bdc2.js"><link rel="prefetch" href="/blog/assets/js/19.c6e110df.js"><link rel="prefetch" href="/blog/assets/js/20.4a33f06a.js"><link rel="prefetch" href="/blog/assets/js/21.28170e84.js"><link rel="prefetch" href="/blog/assets/js/22.9358a818.js"><link rel="prefetch" href="/blog/assets/js/23.136a0f54.js"><link rel="prefetch" href="/blog/assets/js/24.499aeaaf.js"><link rel="prefetch" href="/blog/assets/js/25.3cff72a1.js"><link rel="prefetch" href="/blog/assets/js/26.4ee8c52f.js"><link rel="prefetch" href="/blog/assets/js/27.6e099c82.js"><link rel="prefetch" href="/blog/assets/js/28.bfc3427b.js"><link rel="prefetch" href="/blog/assets/js/29.ce801df4.js"><link rel="prefetch" href="/blog/assets/js/30.724cfbb6.js"><link rel="prefetch" href="/blog/assets/js/31.ffd0a663.js"><link rel="prefetch" href="/blog/assets/js/32.feba734b.js"><link rel="prefetch" href="/blog/assets/js/33.e8d22227.js"><link rel="prefetch" href="/blog/assets/js/34.a12f435a.js"><link rel="prefetch" href="/blog/assets/js/35.31d4b272.js"><link rel="prefetch" href="/blog/assets/js/36.a6d04eab.js"><link rel="prefetch" href="/blog/assets/js/37.d8aae5c8.js"><link rel="prefetch" href="/blog/assets/js/38.2d9e0b46.js"><link rel="prefetch" href="/blog/assets/js/39.f9bd73de.js"><link rel="prefetch" href="/blog/assets/js/4.850a33ae.js"><link rel="prefetch" href="/blog/assets/js/40.5ef065c5.js"><link rel="prefetch" href="/blog/assets/js/41.014df883.js"><link rel="prefetch" href="/blog/assets/js/42.199ac029.js"><link rel="prefetch" href="/blog/assets/js/43.69e01de9.js"><link rel="prefetch" href="/blog/assets/js/44.b00eed2f.js"><link rel="prefetch" href="/blog/assets/js/45.f676a314.js"><link rel="prefetch" href="/blog/assets/js/46.d76b7b8a.js"><link rel="prefetch" href="/blog/assets/js/48.629ae724.js"><link rel="prefetch" href="/blog/assets/js/49.3f36b8cf.js"><link rel="prefetch" href="/blog/assets/js/5.c1ab3a44.js"><link rel="prefetch" href="/blog/assets/js/50.6429bdc0.js"><link rel="prefetch" href="/blog/assets/js/51.b7cb8687.js"><link rel="prefetch" href="/blog/assets/js/52.7360a167.js"><link rel="prefetch" href="/blog/assets/js/53.fb5fcabb.js"><link rel="prefetch" href="/blog/assets/js/54.f5ac5958.js"><link rel="prefetch" href="/blog/assets/js/55.592b0348.js"><link rel="prefetch" href="/blog/assets/js/56.d17f3acb.js"><link rel="prefetch" href="/blog/assets/js/57.11aeb3ed.js"><link rel="prefetch" href="/blog/assets/js/58.1b2f9f8b.js"><link rel="prefetch" href="/blog/assets/js/59.c5633b7a.js"><link rel="prefetch" href="/blog/assets/js/6.0106dfd1.js"><link rel="prefetch" href="/blog/assets/js/60.230b2314.js"><link rel="prefetch" href="/blog/assets/js/61.f9cb1ad6.js"><link rel="prefetch" href="/blog/assets/js/62.92f2597d.js"><link rel="prefetch" href="/blog/assets/js/63.25fe8e93.js"><link rel="prefetch" href="/blog/assets/js/64.08acc4bc.js"><link rel="prefetch" href="/blog/assets/js/65.cba08f56.js"><link rel="prefetch" href="/blog/assets/js/66.2aff3910.js"><link rel="prefetch" href="/blog/assets/js/67.23dfb624.js"><link rel="prefetch" href="/blog/assets/js/68.7e1a9696.js"><link rel="prefetch" href="/blog/assets/js/69.127d4ccb.js"><link rel="prefetch" href="/blog/assets/js/7.34cfb431.js"><link rel="prefetch" href="/blog/assets/js/70.cb7a9ca8.js"><link rel="prefetch" href="/blog/assets/js/71.fc5012c0.js"><link rel="prefetch" href="/blog/assets/js/72.04308961.js"><link rel="prefetch" href="/blog/assets/js/73.3b80efd9.js"><link rel="prefetch" href="/blog/assets/js/74.009897a1.js"><link rel="prefetch" href="/blog/assets/js/75.00bb0c95.js"><link rel="prefetch" href="/blog/assets/js/76.0b9619cc.js"><link rel="prefetch" href="/blog/assets/js/77.3cdf8f24.js"><link rel="prefetch" href="/blog/assets/js/78.2db1c727.js"><link rel="prefetch" href="/blog/assets/js/79.342c3faa.js"><link rel="prefetch" href="/blog/assets/js/8.51e80c5b.js"><link rel="prefetch" href="/blog/assets/js/80.0439653b.js"><link rel="prefetch" href="/blog/assets/js/81.6c0e9802.js"><link rel="prefetch" href="/blog/assets/js/82.e6e1608a.js"><link rel="prefetch" href="/blog/assets/js/83.39a82281.js"><link rel="prefetch" href="/blog/assets/js/84.4415141b.js"><link rel="prefetch" href="/blog/assets/js/85.00b63f10.js"><link rel="prefetch" href="/blog/assets/js/86.1581db60.js"><link rel="prefetch" href="/blog/assets/js/87.4c47bbc2.js"><link rel="prefetch" href="/blog/assets/js/88.10af48c1.js"><link rel="prefetch" href="/blog/assets/js/89.84840655.js"><link rel="prefetch" href="/blog/assets/js/9.c76e1545.js"><link rel="prefetch" href="/blog/assets/js/90.574990da.js"><link rel="prefetch" href="/blog/assets/js/91.a1094788.js"><link rel="prefetch" href="/blog/assets/js/92.7070acb6.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.389ed919.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/TB5.PNG" alt="Tang's Blog" class="logo"> <span class="site-name can-hide">Tang's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术笔记" class="dropdown-title"><span class="title">技术笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="技术笔记" class="mobile-dropdown-title"><span class="title">技术笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/java/" class="nav-link">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/blog/frontend/" class="nav-link">
  前端
</a></li><li class="dropdown-item"><!----> <a href="/blog/db/" class="nav-link">
  DB
</a></li><li class="dropdown-item"><!----> <a href="/blog/microservice/" class="nav-link">
  微服务
</a></li><li class="dropdown-item"><!----> <a href="/blog/distribution/" class="nav-link">
  分布式
</a></li><li class="dropdown-item"><!----> <a href="/blog/bigdata/" class="nav-link">
  大数据
</a></li><li class="dropdown-item"><!----> <a href="/blog/devops/" class="nav-link router-link-active">
  DevOps
</a></li><li class="dropdown-item"><!----> <a href="/blog/newlanguage/" class="nav-link">
  新语言
</a></li><li class="dropdown-item"><!----> <a href="/blog/othertool/" class="nav-link">
  其他工具
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/readbook/" class="nav-link">
  读书分享
</a></li><li class="dropdown-item"><!----> <a href="/blog/guitar/" class="nav-link">
  吉他谱
</a></li><li class="dropdown-item"><!----> <a href="/blog/food/" class="nav-link">
  饮食
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术笔记" class="dropdown-title"><span class="title">技术笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="技术笔记" class="mobile-dropdown-title"><span class="title">技术笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/java/" class="nav-link">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/blog/frontend/" class="nav-link">
  前端
</a></li><li class="dropdown-item"><!----> <a href="/blog/db/" class="nav-link">
  DB
</a></li><li class="dropdown-item"><!----> <a href="/blog/microservice/" class="nav-link">
  微服务
</a></li><li class="dropdown-item"><!----> <a href="/blog/distribution/" class="nav-link">
  分布式
</a></li><li class="dropdown-item"><!----> <a href="/blog/bigdata/" class="nav-link">
  大数据
</a></li><li class="dropdown-item"><!----> <a href="/blog/devops/" class="nav-link router-link-active">
  DevOps
</a></li><li class="dropdown-item"><!----> <a href="/blog/newlanguage/" class="nav-link">
  新语言
</a></li><li class="dropdown-item"><!----> <a href="/blog/othertool/" class="nav-link">
  其他工具
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/readbook/" class="nav-link">
  读书分享
</a></li><li class="dropdown-item"><!----> <a href="/blog/guitar/" class="nav-link">
  吉他谱
</a></li><li class="dropdown-item"><!----> <a href="/blog/food/" class="nav-link">
  饮食
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Github</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/devops/repository/github.html" class="sidebar-link">GitHub</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Jenkins</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/devops/ci/jenkins.html" class="sidebar-link">Jenkins</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>容器</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>Kubenetes</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/devops/container/k8s/k8s-1.html" class="sidebar-link">Kubenetes简介</a></li><li><a href="/blog/devops/container/k8s/k8s-2.html" class="sidebar-link">搭建Kubenetes</a></li><li><a href="/blog/devops/container/k8s/k8s-3.html" class="sidebar-link">Kubernetes集群管理工具kubectl</a></li><li><a href="/blog/devops/container/k8s/k8s-4.html" class="sidebar-link">Kubernetes集群YAML文件详解</a></li><li><a href="/blog/devops/container/k8s/k8s-5.html" class="sidebar-link">Kubernetes核心技术Pod</a></li><li><a href="/blog/devops/container/k8s/k8s-6.html" aria-current="page" class="active sidebar-link">Kubernetes核心技术-Controller</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/devops/container/k8s/k8s-6.html#内容" class="sidebar-link">内容</a></li><li class="sidebar-sub-header"><a href="/blog/devops/container/k8s/k8s-6.html#什么是controller" class="sidebar-link">什么是Controller</a></li><li class="sidebar-sub-header"><a href="/blog/devops/container/k8s/k8s-6.html#pod和controller的关系" class="sidebar-link">Pod和Controller的关系</a></li><li class="sidebar-sub-header"><a href="/blog/devops/container/k8s/k8s-6.html#deployment控制器应用" class="sidebar-link">Deployment控制器应用</a></li><li class="sidebar-sub-header"><a href="/blog/devops/container/k8s/k8s-6.html#deployment部署应用" class="sidebar-link">Deployment部署应用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/devops/container/k8s/k8s-6.html#使用yaml创建pod" class="sidebar-link">使用YAML创建Pod</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/devops/container/k8s/k8s-6.html#升级回滚和弹性伸缩" class="sidebar-link">升级回滚和弹性伸缩</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/devops/container/k8s/k8s-6.html#应用升级和回滚" class="sidebar-link">应用升级和回滚</a></li><li class="sidebar-sub-header"><a href="/blog/devops/container/k8s/k8s-6.html#弹性伸缩" class="sidebar-link">弹性伸缩</a></li></ul></li></ul></li><li><a href="/blog/devops/container/k8s/k8s-7.html" class="sidebar-link">Kubernetes核心技术Service</a></li><li><a href="/blog/devops/container/k8s/k8s-8.html" class="sidebar-link">Kubernetes控制器Controller详解</a></li><li><a href="/blog/devops/container/k8s/k8s-9.html" class="sidebar-link">Kubernetes配置管理</a></li><li><a href="/blog/devops/container/k8s/k8s-10.html" class="sidebar-link">Kubernetes集群安全机制</a></li><li><a href="/blog/devops/container/k8s/k8s-11.html" class="sidebar-link">Kubernetes核心技术Ingress</a></li><li><a href="/blog/devops/container/k8s/k8s-12.html" class="sidebar-link">Kubernetes核心技术Helm</a></li><li><a href="/blog/devops/container/k8s/k8s-13.html" class="sidebar-link">Kubernetes持久化存储</a></li><li><a href="/blog/devops/container/k8s/k8s-14.html" class="sidebar-link">Kubernetes集群资源监控</a></li><li><a href="/blog/devops/container/k8s/k8s-15.html" class="sidebar-link">Kubernetes搭建高可用集群</a></li><li><a href="/blog/devops/container/k8s/k8s-16.html" class="sidebar-link">Kubernetes容器交付介绍</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>Docker</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/devops/container/docker1.html" class="sidebar-link">Docker基础</a></li><li><a href="/blog/devops/container/docker2.html" class="sidebar-link">Docker进阶</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>日志分析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/devops/log/elk.html" class="sidebar-link">ELK</a></li><li><a href="/blog/devops/log/splunk.html" class="sidebar-link">Splunk</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>监控</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/devops/monitor/promethus.html" class="sidebar-link">Promethus</a></li><li><a href="/blog/devops/monitor/dynatrace.html" class="sidebar-link">Dynatrace</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="kubernetes核心技术-controller"><a href="#kubernetes核心技术-controller" class="header-anchor">#</a> Kubernetes核心技术-Controller</h1> <h2 id="内容"><a href="#内容" class="header-anchor">#</a> 内容</h2> <ul><li>什么是Controller</li> <li>Pod和Controller的关系</li> <li>Deployment控制器应用场景</li> <li>yaml文件字段说明</li> <li>Deployment控制器部署应用</li> <li>升级回滚</li> <li>弹性伸缩</li></ul> <h2 id="什么是controller"><a href="#什么是controller" class="header-anchor">#</a> 什么是Controller</h2> <p>Controller是在集群上管理和运行容器的对象，Controller是实际存在的，Pod是虚拟机的</p> <h2 id="pod和controller的关系"><a href="#pod和controller的关系" class="header-anchor">#</a> Pod和Controller的关系</h2> <p>Pod是通过Controller实现应用的运维，比如弹性伸缩，滚动升级等</p> <p>Pod 和 Controller之间是通过label标签来建立关系，同时Controller又被称为控制器工作负载</p> <p><img src="images/image-20201116092431237.png" alt="image-20201116092431237"></p> <h2 id="deployment控制器应用"><a href="#deployment控制器应用" class="header-anchor">#</a> Deployment控制器应用</h2> <ul><li>Deployment控制器可以部署无状态应用</li> <li>管理Pod和ReplicaSet</li> <li>部署，滚动升级等功能</li> <li>应用场景：web服务，微服务</li></ul> <p>Deployment表示用户对K8S集群的一次更新操作。Deployment是一个比RS( Replica Set, RS) 应用模型更广的 API 对象，可以是创建一个新的服务，更新一个新的服务，也可以是滚动升级一个服务。滚动升级一个服务，实际是创建一个新的RS，然后逐渐将新 RS 中副本数增加到理想状态，将旧RS中的副本数减少到0的复合操作。</p> <p>这样一个复合操作用一个RS是不好描述的，所以用一个更通用的Deployment来描述。以K8S的发展方向，未来对所有长期伺服型的业务的管理，都会通过Deployment来管理。</p> <h2 id="deployment部署应用"><a href="#deployment部署应用" class="header-anchor">#</a> Deployment部署应用</h2> <p>之前我们也使用Deployment部署过应用，如下代码所示</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectrl create deployment web --image<span class="token operator">=</span>nginx
</code></pre></div><p>但是上述代码不是很好的进行复用，因为每次我们都需要重新输入代码，所以我们都是通过YAML进行配置</p> <p>但是我们可以尝试使用上面的代码创建一个镜像【只是尝试，不会创建】</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl create deployment web --image<span class="token operator">=</span>nginx --dry-run -o yaml <span class="token operator">&gt;</span> nginx.yaml
</code></pre></div><p>然后输出一个yaml配置文件 <code>nginx.yml</code> ，配置文件如下所示</p> <div class="language-bash extra-class"><pre class="language-bash"><code>apiVersion: apps/v1
kind: Deployment
metadata:
  creationTimestamp: null
  labels:
    app: web
  name: web
spec:
  replicas: <span class="token number">1</span>
  selector:
    matchLabels:
      app: web
  strategy: <span class="token punctuation">{</span><span class="token punctuation">}</span>
  template:
    metadata:
      creationTimestamp: null
      labels:
        app: web
    spec:
      containers:
      - image: nginx
        name: nginx
        resources: <span class="token punctuation">{</span><span class="token punctuation">}</span>
status: <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>我们看到的 selector 和 label 就是我们Pod 和 Controller之间建立关系的桥梁</p> <p><img src="images/image-20201116093638951.png" alt="image-20201116093638951"></p> <h3 id="使用yaml创建pod"><a href="#使用yaml创建pod" class="header-anchor">#</a> 使用YAML创建Pod</h3> <p>通过刚刚的代码，我们已经生成了YAML文件，下面我们就可以使用该配置文件快速创建Pod镜像了</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl apply -f nginx.yaml
</code></pre></div><p><img src="images/image-20201116094046007.png" alt="image-20201116094046007"></p> <p>但是因为这个方式创建的，我们只能在集群内部进行访问，所以我们还需要对外暴露端口</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl expose deployment web --port<span class="token operator">=</span><span class="token number">80</span> --type<span class="token operator">=</span>NodePort --target-port<span class="token operator">=</span><span class="token number">80</span> --name<span class="token operator">=</span>web1
</code></pre></div><p>关于上述命令，有几个参数</p> <ul><li>--port：就是我们内部的端口号</li> <li>--target-port：就是暴露外面访问的端口号</li> <li>--name：名称</li> <li>--type：类型</li></ul> <p>同理，我们一样可以导出对应的配置文件</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl expose deployment web --port<span class="token operator">=</span><span class="token number">80</span> --type<span class="token operator">=</span>NodePort --target-port<span class="token operator">=</span><span class="token number">80</span> --name<span class="token operator">=</span>web1 -o yaml <span class="token operator">&gt;</span> web1.yaml
</code></pre></div><p>得到的web1.yaml如下所示</p> <div class="language-bash extra-class"><pre class="language-bash"><code>apiVersion: v1
kind: Service
metadata:
  creationTimestamp: <span class="token string">&quot;2020-11-16T02:26:53Z&quot;</span>
  labels:
    app: web
  managedFields:
  - apiVersion: v1
    fieldsType: FieldsV1
    fieldsV1:
      f:metadata:
        f:labels:
          .: <span class="token punctuation">{</span><span class="token punctuation">}</span>
          f:app: <span class="token punctuation">{</span><span class="token punctuation">}</span>
      f:spec:
        f:externalTrafficPolicy: <span class="token punctuation">{</span><span class="token punctuation">}</span>
        f:ports:
          .: <span class="token punctuation">{</span><span class="token punctuation">}</span>
          k:<span class="token punctuation">{</span><span class="token string">&quot;port&quot;</span>:80,<span class="token string">&quot;protocol&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;TCP&quot;</span><span class="token punctuation">}</span>:
            .: <span class="token punctuation">{</span><span class="token punctuation">}</span>
            f:port: <span class="token punctuation">{</span><span class="token punctuation">}</span>
            f:protocol: <span class="token punctuation">{</span><span class="token punctuation">}</span>
            f:targetPort: <span class="token punctuation">{</span><span class="token punctuation">}</span>
        f:selector:
          .: <span class="token punctuation">{</span><span class="token punctuation">}</span>
          f:app: <span class="token punctuation">{</span><span class="token punctuation">}</span>
        f:sessionAffinity: <span class="token punctuation">{</span><span class="token punctuation">}</span>
        f:type: <span class="token punctuation">{</span><span class="token punctuation">}</span>
    manager: kubectl
    operation: Update
    time: <span class="token string">&quot;2020-11-16T02:26:53Z&quot;</span>
  name: web2
  namespace: default
  resourceVersion: <span class="token string">&quot;113693&quot;</span>
  selfLink: /api/v1/namespaces/default/services/web2
  uid: d570437d-a6b4-4456-8dfb-950f09534516
spec:
  clusterIP: <span class="token number">10.104</span>.174.145
  externalTrafficPolicy: Cluster
  ports:
  - nodePort: <span class="token number">32639</span>
    port: <span class="token number">80</span>
    protocol: TCP
    targetPort: <span class="token number">80</span>
  selector:
    app: web
  sessionAffinity: None
  type: NodePort
status:
  loadBalancer: <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>然后我们可以通过下面的命令来查看对外暴露的服务</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl get pods,svc
</code></pre></div><p><img src="images/image-20201116104021357.png" alt="image-20201116104021357"></p> <p>然后我们访问对应的url，即可看到 nginx了 <code>http://192.168.177.130:32639/</code></p> <p><img src="images/image-20201116104131968.png" alt="image-20201116104131968"></p> <h2 id="升级回滚和弹性伸缩"><a href="#升级回滚和弹性伸缩" class="header-anchor">#</a> 升级回滚和弹性伸缩</h2> <ul><li>升级：  假设从版本为1.14 升级到 1.15 ，这就叫应用的升级【升级可以保证服务不中断】</li> <li>回滚：从版本1.15 变成 1.14，这就叫应用的回滚</li> <li>弹性伸缩：我们根据不同的业务场景，来改变Pod的数量对外提供服务，这就是弹性伸缩</li></ul> <h3 id="应用升级和回滚"><a href="#应用升级和回滚" class="header-anchor">#</a> 应用升级和回滚</h3> <p>首先我们先创建一个 1.14版本的Pod</p> <div class="language-bash extra-class"><pre class="language-bash"><code>apiVersion: apps/v1
kind: Deployment
metadata:
  creationTimestamp: null
  labels:
    app: web
  name: web
spec:
  replicas: <span class="token number">1</span>
  selector:
    matchLabels:
      app: web
  strategy: <span class="token punctuation">{</span><span class="token punctuation">}</span>
  template:
    metadata:
      creationTimestamp: null
      labels:
        app: web
    spec:
      containers:
      - image: nginx:1.14
        name: nginx
        resources: <span class="token punctuation">{</span><span class="token punctuation">}</span>
status: <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>我们先指定版本为1.14，然后开始创建我们的Pod</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl apply -f nginx.yaml
</code></pre></div><p>同时，我们使用docker images命令，就能看到我们成功拉取到了一个 1.14版本的镜像</p> <p><img src="images/image-20201116105710966.png" alt="image-20201116105710966"></p> <p>我们使用下面的命令，可以将nginx从 1.14 升级到 1.15</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl <span class="token builtin class-name">set</span> image deployment web <span class="token assign-left variable">nginx</span><span class="token operator">=</span>nginx:1.15
</code></pre></div><p>在我们执行完命令后，能看到升级的过程</p> <p><img src="images/image-20201116105847069.png" alt="image-20201116105847069"></p> <ul><li>首先是开始的nginx 1.14版本的Pod在运行，然后 1.15版本的在创建</li> <li>然后在1.15版本创建完成后，就会暂停1.14版本</li> <li>最后把1.14版本的Pod移除，完成我们的升级</li></ul> <p>我们在下载 1.15版本，容器就处于ContainerCreating状态，然后下载完成后，就用 1.15版本去替换1.14版本了，这么做的好处就是：升级可以保证服务不中断</p> <p><img src="images/image-20201116111614085.png" alt="image-20201116111614085"></p> <p>我们到我们的node2节点上，查看我们的 docker images;</p> <p><img src="images/image-20201116111315000.png" alt="image-20201116111315000"></p> <p>能够看到，我们已经成功拉取到了 1.15版本的nginx了</p> <h4 id="查看升级状态"><a href="#查看升级状态" class="header-anchor">#</a> 查看升级状态</h4> <p>下面可以，查看升级状态</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl rollout status deployment web
</code></pre></div><p><img src="images/image-20201116112139645.png" alt="image-20201116112139645"></p> <h4 id="查看历史版本"><a href="#查看历史版本" class="header-anchor">#</a> 查看历史版本</h4> <p>我们还可以查看历史版本</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl rollout <span class="token function">history</span> deployment web
</code></pre></div><h4 id="应用回滚"><a href="#应用回滚" class="header-anchor">#</a> 应用回滚</h4> <p>我们可以使用下面命令，完成回滚操作，也就是回滚到上一个版本</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl rollout undo deployment web
</code></pre></div><p>然后我们就可以查看状态</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl rollout status deployment web
</code></pre></div><p><img src="images/image-20201116112524601.png" alt="image-20201116112524601"></p> <p>同时我们还可以回滚到指定版本</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl rollout undo deployment web --to-revision<span class="token operator">=</span><span class="token number">2</span>
</code></pre></div><h3 id="弹性伸缩"><a href="#弹性伸缩" class="header-anchor">#</a> 弹性伸缩</h3> <p>弹性伸缩，也就是我们通过命令一下创建多个副本</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl scale deployment web --replicas<span class="token operator">=</span><span class="token number">10</span>
</code></pre></div><p>能够清晰看到，我们一下创建了10个副本</p> <p><img src="images/image-20201117092841865.png" alt="image-20201117092841865"></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">2/5/2023, 4:38:02 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/devops/container/k8s/k8s-5.html" class="prev">
        Kubernetes核心技术Pod
      </a></span> <span class="next"><a href="/blog/devops/container/k8s/k8s-7.html">
        Kubernetes核心技术Service
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/blog/assets/js/app.96a63ad2.js" defer></script><script src="/blog/assets/js/2.e671b9b2.js" defer></script><script src="/blog/assets/js/3.be9bea65.js" defer></script><script src="/blog/assets/js/47.fa6622ba.js" defer></script>
  </body>
</html>
